<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>MAGE API Documentation</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="api" data-languages="[]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" alt="Logo" />
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='./index.html'>User Guide</a></li>
            <li><a href='https://github.com/mage/mage'>GitHub</a></li>
            <li><a href='https://wizcorp.jp/mage'>MAGE website</a></li>
            <li><a href='https://wizcorp.jp/'>Wizcorp website</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <div class="title">MAGE API Documentation</div>
        <p>Here you will find the complete MAGE API documentation. If you are
just getting started, you might want to have a look at the
<a href="./">User Guide</a> first.</p>

<h2 id="modules">Modules</h2>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">useModules</span><span class="p">([</span>
    <span class="s1">'session'</span>
<span class="p">]);</span>
</code></pre>
<p>In addition to the MAGE API, the following core modules are also available for use.</p>

<ul>
<li><a href="https://github.com/mage/mage/tree/master/lib/modules/session">Sessions</a></li>
<li><a href="https://github.com/mage/mage/tree/master/lib/modules/auth">Auth</a></li>
<li><a href="https://github.com/mage/mage/tree/master/lib/modules/time">Time</a></li>
</ul>

<p>In each case, you will need to make sure to add the module name to your <code class="prettyprint">mage.useModules()</code> call.</p>

          <h1 id="mage">MAGE</h1>

<p>The first line of code in your project is probably the following.</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">mage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mage'</span><span class="p">);</span>
</code></pre>
<p>You&rsquo;re going to write that a lot, as its the entry point into everything in the framework, including
the modules you write and register. You can require &ldquo;mage&rdquo; from anywhere in your project.</p>

<h2 id="properties">Properties</h2>

<h3 id="object-mage-task">Object mage.task</h3>

<p>The name and options for the task that the command line interface has decided MAGE should execute.
This defaults to the &ldquo;serve&rdquo; task, which means to serve applications to clients. All
<a href="../tasks">tasks</a> available to MAGE are implemented through the CLI. You can run your application
with <code class="prettyprint">--help</code> to get an idea of which tasks you can activate. You can manually change the task
through the <code class="prettyprint">setTask</code> API documented under &ldquo;Methods&rdquo;.</p>

<h3 id="object-mage-core">Object mage.core</h3>

<p>Contains all the subsystems that MAGE has access to. These are integrated into the system mode
deeply than <a href="../../docs/walkthrough/Modules.md">modules</a> are, which you use to add application logic
to the MAGE app.</p>

<p>The subsystems in &ldquo;core&rdquo; are documented in the <a href="../../docs/api/Readme.md">API documentation</a>.</p>

<h3 id="string-mage-version">string mage.version</h3>

<p>The version of MAGE.</p>

<h3 id="object-mage-magepackage">Object mage.magePackage</h3>

<p>Contains information from MAGE&rsquo;s <code class="prettyprint">package.json</code> file:</p>

<ul>
<li>name: &ldquo;mage&rdquo;</li>
<li>version: The version of MAGE.</li>
<li>path: The path to MAGE on disk.</li>
<li>package: The parsed contents of MAGE&rsquo;s <code class="prettyprint">package.json</code> file.</li>
</ul>

<h3 id="object-mage-rootpackage">Object mage.rootPackage</h3>

<p>Contains information from your project&rsquo;s <code class="prettyprint">package.json</code> file:</p>

<ul>
<li>name: The &ldquo;name&rdquo; field of package.json, or the folder name of your project.</li>
<li>version: The version of your project (or &ldquo;no-version&rdquo;).</li>
<li>path: The path to your project on disk.</li>
<li>package: The parsed contents of your project&rsquo;s <code class="prettyprint">package.json</code> file.</li>
</ul>

<h3 id="module-mage-cli">Module mage.cli</h3>

<p>The <code class="prettyprint">cli</code> property is a library that lets you extend and boot up the command-line argument parser.
For more information, please read the <a href="../cli/Readme.md">CLI documentation</a>.</p>

<h2 id="methods">Methods</h2>

<h3 id="module-mage-require-modulename">Module mage.require(moduleName)</h3>

<p>Calls Node.js&rsquo; <code class="prettyprint">require</code> function from the MAGE context. This can be useful when you want to
directly require one of MAGE&rsquo;s own dependencies.</p>

<h3 id="string-mage-getrunstate">string mage.getRunState()</h3>

<p>Returns the lifecycle phase that MAGE is currently in. This can be any of the following.</p>

<ul>
<li>init: before starting up</li>
<li>setup: while starting up</li>
<li>running: while the project is running and is ready to serve requests</li>
<li>quitting: while shutting down</li>
</ul>

<p>Every time the run-state changes, the &ldquo;runState&rdquo; event is emitted, with the current run-state as the
only argument.</p>

<h3 id="mage-quit-number-exitcode">mage.quit(number exitCode)</h3>

<p>Shuts down MAGE and exits the process with the given exit code, or 0 if none has been passed.</p>

<blockquote>
<p>Please note that if you run this in a worker process, it only shuts down the worker, not the
entire project.</p>
</blockquote>

<h3 id="mage-mage-addmodulespath-string-path">Mage mage.addModulesPath(string path)</h3>

<p>Adds this path on the disk as a lookup path for modules when using <code class="prettyprint">useModules()</code>.
Returns the mage object to allow API chaining.</p>

<h3 id="mage-mage-usemodules-string-modulename">Mage mage.useModules(string moduleName, &hellip;)</h3>

<p>Takes any number of arguments that each represent a module&rsquo;s name. Arguments may also be an array
with module names. The modules you refer to are instantly imported from the known module paths (see:
<code class="prettyprint">addModulesPath</code>, or from the MAGE built-in modules, and exposed as <code class="prettyprint">mage.ModuleName</code> as well as
<code class="prettyprint">mage.core.modules.ModuleName</code>.ã€€Returns the mage object to allow API chaining.</p>

<h3 id="string-mage-getmodulepath-string-modulename">string mage.getModulePath(string moduleName)</h3>

<p>If a name by this name has been registered through <code class="prettyprint">useModules()</code>, this method will return the path
on disk where that module was loaded from.</p>

<h3 id="string-mage-listmodules">string[] mage.listModules()</h3>

<p>Returns all registered module names, in order of registration.</p>

<h3 id="mage-mage-setup-function-callback">Mage mage.setup(Function callback)</h3>

<p>Sets up the task that MAGE has been assigned. By default this is to serve the application to
clients. This function considers all errors fatal and will shut down the process if that happens.
Once setup has completed, this functions calls back to <code class="prettyprint">callback(error, appMap)</code></p>

<blockquote>
<p>Please note: while there are no errors returned, the Node.js convention of &ldquo;errors first&rdquo; is still
applied. You may safely ignore this argument.</p>
</blockquote>

<p>The second argument returned in the callback is a map, by name, of application objects that
are now available to you. For example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">appMap</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">game</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
  <span class="na">dev</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
  <span class="na">cms</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
  <span class="na">support</span><span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>The <code class="prettyprint">setup</code> function returns the mage object to allow API chaining.</p>

<h3 id="mage-mage-start-function-callback">Mage mage.start(Function callback)</h3>

<p>This will start the application and expose it to the world. That means that from this moment on,
the HTTP server will be accepting connections and serve your applications. When these final
operations have completed, the callback will be called. In the case of error, MAGE will not return
the error to your callback. It will shut down instead. The <code class="prettyprint">start</code> function returns the mage object
to allow API chaining.</p>

<h3 id="boolean-mage-isdevelopmentmode-string-feature">boolean mage.isDevelopmentMode([string feature])</h3>

<p>Returns <code class="prettyprint">true</code> if MAGE is running in development mode, <code class="prettyprint">false</code> otherwise. If you pass a particular
feature by name, the boolean will reflect on that feature being in development mode or not. For more
information on these features, please read the documentation on
<a href="../../docs/walkthrough/Configuration.md">Configuration</a>.</p>

          <h1 id="state">State</h1>

<p>The state library exposes a constructor that constructs objects which form an interface between an
actor, a session and the archivist. Virtually any command that involves reading and modification of
data should be managed by a state object.</p>

<p>The state constructor is exposed on <code class="prettyprint">mage.core.State</code>. When you&rsquo;re done using the state class,
always make sure to clean it up by calling <code class="prettyprint">close()</code> on it. MAGE&rsquo;s module and command center systems
that bridge the communication between client and server use the State object for API responses and
server-sent events. We explain more about that and the concepts behind the State class in the
<a href="../../docs/walkthrough/Readme.md">walkthrough</a>.</p>

<h2 id="methods">Methods</h2>

<h3 id="state-string-actorid-string-session">State(string actorId, string session)</h3>

<p>The constructor. Pass an <code class="prettyprint">actorId</code> to bind the state to the actor. That way events that are emitted
to this actor will batch up inside this state object, waiting to pulled out for delivery. This is
what MAGE&rsquo;s command center does when returning a response following a user command execution.</p>

<p><strong>Please note: you probably do not want to bind the state object to an actorId.</strong></p>

<p>When you do not pass an actorId, emitting events to it will asynchronously be delivered via MAGE&rsquo;s
message stream system. If you pass a <code class="prettyprint">session</code> object, it can be used for access level and user
language settings.</p>

<h3 id="state-registersession-object-session">state.registerSession(Object session)</h3>

<p>Will register the actorId and session. This is called from the constructor if a session was passed.</p>

<p><strong>Please note: you probably do not want to bind the state object to a session.</strong></p>

<h3 id="state-settimeout-number-msec">state.setTimeout(number msec)</h3>

<p>If the state object is not closed within the given time, it will automatically close itself.</p>

<h3 id="state-cleartimeout">state.clearTimeout()</h3>

<p>If a timeout has been set, this will remove it.</p>

<h3 id="boolean-state-canaccess-string-accesslevel">boolean state.canAccess(string accessLevel)</h3>

<p>Returns <code class="prettyprint">true</code> if the registered session is authorised at the given access level. Returns <code class="prettyprint">false</code> otherwise.</p>

<h3 id="state-setdescription-string-desc">state.setDescription(string desc)</h3>

<p>Tags the state with a description that is used whenever an error is logged from the state object.</p>

<h3 id="string-state-getdescription">string state.getDescription()</h3>

<p>Returns the registered description.</p>

<h3 id="string-state-language">string state.language()</h3>

<p>Returns the language of the registered session. Returns <code class="prettyprint">en</code> if none is known.</p>

<h3 id="state-emit-string-actorid-string-actorids-string-path-data-string-language-boolean-isjson">state.emit(string actorId|string actorIds[], string path, data, string language, boolean isJson)</h3>

<p>Emits an event to the given actorId&rsquo;s client.</p>

<ul>
<li>actorId: The actorId or actorIds (array) to emit to.</li>
<li>path: The event name (or dot separated path).</li>
<li>data: Any data you want to send with this event.</li>
<li>language: A language code that may be given if the data is bound to a single language only.</li>
<li>isJson: If the data is a pre-serialized JSON string, pass <code class="prettyprint">true</code>.</li>
</ul>

<h3 id="state-broadcast-string-path-data-boolean-isjson">state.broadcast(string path, data, boolean isJson)</h3>

<p>Broadcast an event to all the actors.</p>

<ul>
<li>path: The event name (or dot separated path).</li>
<li>data: Any data you want to send with this event.</li>
<li>isJson: If the data is a pre-serialized JSON string, pass <code class="prettyprint">true</code>.</li>
</ul>

<h3 id="state-findactors-string-actorids-function-callback">state.findActors(string actorIds[], Function callback)</h3>

<p>This looks up all actors&rsquo; sessions, to see which actors are online and which are not. This can be useful when managing
a pool of users in a room for example. The callback function receives an error argument (in case of database failure),
and a <code class="prettyprint">found</code> argument which is the following object:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">online</span><span class="p">:</span> <span class="p">[</span><span class="s1">'someActorId'</span><span class="p">,</span> <span class="s1">'someActorId3'</span><span class="p">],</span>
    <span class="na">offline</span><span class="p">:</span> <span class="p">[</span><span class="s1">'someActorId2'</span><span class="p">]</span>
<span class="p">};</span>
</code></pre>
<p>These lists will contain all actorIds you have passed into the function, but divided into an <code class="prettyprint">online</code> and an <code class="prettyprint">offline</code>
group.</p>

<h3 id="state-error-string-code-string-logdetails-function-callback">state.error(string code, string logDetails, Function callback)</h3>

<p>Marks the state as in-error. No archivist mutations will be distributed, and the registered actor
will receive the error <code class="prettyprint">code</code> as the first argument in the client-side callback. Pass <code class="prettyprint">null</code> as a
code for the default &ldquo;server&rdquo; error code. Pass <code class="prettyprint">logDetails</code> to write it to the logger&rsquo;s
error-channel. If you want to call a callback function immediately after, pass it as the third
argument.</p>

<h3 id="state-respond-data">state.respond(data)</h3>

<p>This is the response that will be sent to the actor&rsquo;s client-side callback as the second argument.
This only has meaning if the state originated in the command center.</p>

<h3 id="state-close-function-callback">state.close(Function callback)</h3>

<p>Call this when you&rsquo;re done with the state object. All archivist mutations will now be distributed to
their data stores and events will be sent to the client. If an error has been registered, all
archivist changes, all events, and the response will be discarded. Error or no error, <em>always</em> make
sure to close the state object when you&rsquo;re done with it.</p>

<h2 id="usage-example">Usage example</h2>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">State</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">State</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">State</span><span class="p">(</span><span class="s1">'abc'</span><span class="p">);</span>

<span class="nx">state</span><span class="p">.</span><span class="nx">archivist</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'player'</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">actorId</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">actorId</span><span class="p">,</span> <span class="s1">'myevent'</span><span class="p">,</span> <span class="p">{</span> <span class="na">hello</span><span class="p">:</span> <span class="s1">'world'</span><span class="p">,</span> <span class="na">youAre</span><span class="p">:</span> <span class="nx">player</span> <span class="p">});</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Player:'</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">state</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
<h2 id="read-more">Read more</h2>

<ul>
<li><a href="../../docs/walkthrough/Events.md">Events</a></li>
</ul>

          <h1 id="archivist">Archivist</h1>

<p>The archivist rules your data. Its purpose is to help you manage your data,
all through a simple unified API, regardless of which data stores you use.</p>

<h2 id="advantages">Advantages</h2>

<h3 id="schema-migration">Schema Migration</h3>

<p>Schema Migration between versions is well supported out of the box. Please read the
<a href="./Migrations.md">documentation</a>.</p>

<h3 id="redundant-storage">Redundant storage</h3>

<p>You can configure multiple data stores of the same type, in order to split your data into as many
MySQL databases, couchbase clusters and file systems as you want.</p>

<p>This allows you to write to many stores at once (defined by write-order). It also allows you to
configure a read-order, by which data gets loaded. This is very useful in scenarios like &ldquo;try
memcached first, else try MySQL&rdquo;.</p>

<h3 id="friendly-default-integration-logic-with-a-bunch-of-database-systems">Friendly default integration logic with a bunch of database systems</h3>

<p>For all built-in data stores, all serialization and access logic is built-in with friendly default
behaviors. That means that you can store into a key/value store like memcached and into an SQL
data store &ndash; through a single API &ndash; without having to program or configure anything specific.</p>

<h3 id="a-solution-for-static-content">A solution for static content</h3>

<p>The archivist API works equally well for SQL databases, key/value stores and file storage. That
means that it&rsquo;s an out-of-the-box solution for your static content, using an API that is consistent
with how you manage all your other data.</p>

<h3 id="highly-customizable-database-integration-if-needed">Highly customizable database integration if needed</h3>

<p>Whenever you do want full control over how data gets stored, you have the ability to do so.</p>

<h3 id="integration-with-tomes">Integration with tomes</h3>

<p>Integration with <a href="https://npmjs.org/package/tomes">tomes</a> is built in. This has a number of specific
advantages.</p>

<ul>
<li>No need to tell archivist to store changes, since they are automatically detected.</li>
<li>Tomes can be transported transparently to and from the browser.</li>
</ul>

<h2 id="terminology">Terminology</h2>

<h3 id="topics-and-indexes">Topics and Indexes</h3>

<p>Each document you store is identified by a topic and an index. Topic is always a string, and
index is always a key/value object. Some typical examples of topic/index pairs could be:</p>
<pre class="highlight plaintext tab-plaintext"><code>topic: "player", index: { actorId: 123 }
topic: "inventory", index: { actorId: "456" }
topic: "cards", index: { actorId: 123, type: "deck" }
</code></pre>
<p>In SQL terms: consider topic your table, and index your primary key.</p>

<h3 id="vaults">Vaults</h3>

<p>Vaults represent the data stores where your data is stored. Each vault type has its own API for
talking to the underlying service, but also exposes a separate <code class="prettyprint">Archive API</code> that is used internally
to store documents. You generally won&rsquo;t access vaults directly. You can leave that to the archivist.
You will however have to configure them, so that each vault knows where to store data.</p>

<p>See the Vaults section of this documentation to learn more about available vaults and
their capabilities.</p>

<h3 id="archivist">Archivist</h3>

<p>The <em>archivist</em> directs your documents to-and-from the vaults. It&rsquo;s your primary point of access,
and provides a simple API for reading and writing data. In MAGE, you can always access it through
<code class="prettyprint">state.archivist</code>.</p>

<h3 id="topic-api">Topic API</h3>

<p>Topic APIs are APIs that, uniquely per vault, implement how values are stored and read. A lot of
this logic is driven around &ldquo;topics&rdquo; and &ldquo;indexes&rdquo;, that these APIs can translate into logic that
fits the vault in question.</p>

<p>For example, the topic <code class="prettyprint">weapons</code> with index <code class="prettyprint">{ actorId: 123 }</code> can be translated into the following
memcached key: <code class="prettyprint">weapons/actorId:123</code>, or into the following MySQL structure:</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w"> </span><span class="s2">"table"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weapons"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pk"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"actorId"</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Each vault has friendly defaults, but those can always be overridden with custom logic. For more
information on how to do this, please read &ldquo;Writing your own Topic API&rdquo;.</p>

<h3 id="mediatypes">MediaTypes</h3>

<p>Each document that is stored, can be stored along with its media type. Think of <code class="prettyprint">image/jpeg</code>,
<code class="prettyprint">text/plain</code>, <code class="prettyprint">application/octet-stream</code>, <code class="prettyprint">application/json</code>, but also <code class="prettyprint">application/x-tome</code>.
Media types can be useful in order to recreate a living version of binary- or string-serialized
data. Archivist comes with built-in knowledge of media types and has the ability to convert between
them.</p>

<p>If you want to create a fresh new Tome, you must conjure it, as described in the documentation of
<a href="https://npmjs.org/package/tomes">node-tomes</a>. You may also store other types of data. Tomes are
simply supported out-of-the-box and you are encouraged to use them. You can access the <code class="prettyprint">Tome</code> class
by requiring it from MAGE by calling:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">Tome</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">'tomes'</span><span class="p">).</span><span class="nx">Tome</span><span class="p">;</span>
</code></pre>
<h2 id="quick-start-guide">Quick start guide</h2>

<p>To start using archivist in your game, you will have to execute the following steps.</p>

<h3 id="configure-your-vaults">Configure your vaults</h3>

<p>The archivist configuration sits on the root of your config file under the label <code class="prettyprint">archivist</code>. It
contains 3 child labels:</p>

<ul>
<li><code class="prettyprint">vaults</code> describes where you store all your data. The keys are the names you give to your vaults.</li>
<li><code class="prettyprint">listOrder</code> is an array with vault names, describing the order in which we list indexes.</li>
<li><code class="prettyprint">readOrder</code> is an array with vault names, describing the order in which we read data.</li>
<li><code class="prettyprint">writeOrder</code> is an array with vault names, describing the order in which we write data.</li>
</ul>

<p>The vaults entry is a key/value map, where the key is the unique <em>name</em> of the vault. It&rsquo;s up to you
to decide on these names. Perhaps often, the name of the vault will match the type of the vault, but
this is absolutely not required. Choose whatever makes sense for your project. The only name that is
reserved is <code class="prettyprint">client</code>, which is named that way by the MAGE command center. You will want to make
sure that the <code class="prettyprint">client</code> vault is represented in your <code class="prettyprint">writeOrder</code>.</p>

<p>It&rsquo;s important to note that the <code class="prettyprint">listOrder</code>, <code class="prettyprint">readOrder</code> and <code class="prettyprint">writeOrder</code> are system-wide. It&rsquo;s
likely that not every topic will be stored on every vault. Whenever we read or write a given topic,
the configured order is traversed, and vaults not linked to the topic are ignored. You cannot change
the ordering for individual topics.</p>

<p>Each vault entry in the configuration has 2 properties: <code class="prettyprint">type</code> and <code class="prettyprint">config</code>. The type property is a
fixed ID that is unique for each type of vault. Read the vault documentation referred to in the
<em>Vaults</em> section to see these IDs and how to configure vaults of that type.</p>

<p>Example configuration:</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"archivist"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"vaults"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"static"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp"</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"memcached"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"memcached"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"servers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"localhost:11211"</span><span class="p">],</span><span class="w"> </span><span class="s2">"prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bob/"</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"mysql"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mysql"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mysql://bob:secret@localhost/bob_game"</span><span class="w"> </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"listOrder"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"mysql"</span><span class="p">,</span><span class="w"> </span><span class="s2">"static"</span><span class="p">],</span><span class="w">
        </span><span class="s2">"readOrder"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"memcached"</span><span class="p">,</span><span class="w"> </span><span class="s2">"mysql"</span><span class="p">,</span><span class="w"> </span><span class="s2">"static"</span><span class="p">],</span><span class="w">
        </span><span class="s2">"writeOrder"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"client"</span><span class="p">,</span><span class="w"> </span><span class="s2">"memcached"</span><span class="p">,</span><span class="w"> </span><span class="s2">"mysql"</span><span class="p">,</span><span class="w"> </span><span class="s2">"static"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h3 id="configure-your-topics">Configure your topics</h3>

<p>In your game&rsquo;s <code class="prettyprint">lib</code> folder, please create a new folder called <code class="prettyprint">archivist</code>. This folder will be
<code class="prettyprint">require</code>d by MAGE&rsquo;s archivist, in order to receive your topic configuration per vault-name.
Consider doing the whole configuration in one file: <code class="prettyprint">lib/archivist/index.js</code>.</p>

<p>The format is as follows:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">myTopicName</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">mediaType</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">,</span>
    <span class="na">readOptions</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">},</span>
    <span class="na">index</span><span class="p">:</span> <span class="p">[</span><span class="s1">'propName'</span><span class="p">,</span> <span class="s1">'propName'</span><span class="p">],</span>
    <span class="na">vaults</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">myVaultName</span><span class="p">:</span> <span class="nx">myTopicAPI</span>
    <span class="p">},</span>
    <span class="na">afterLoad</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>Where you do this for each topic you want to store in your vaults. The <code class="prettyprint">index</code> array must be
provided if your topic depends on an index. This array is the signature of the indexes you will
provide when referring to data.</p>

<p>If <code class="prettyprint">mediaType</code> is provided, this topic&rsquo;s media type will default to the specified value. </p>

<p>The <code class="prettyprint">readOptions</code> object may be supplied to overwrite default <code class="prettyprint">options</code> that are used when reading
from your archivist. The following defaults are defined, and they can be individually replaced:</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"mediaTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"application/x-tome"</span><span class="p">,</span><span class="w"> </span><span class="s2">"application/octet-stream"</span><span class="p">],</span><span class="w">
    </span><span class="s2">"encodings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"live"</span><span class="p">],</span><span class="w">
    </span><span class="s2">"optional"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The <code class="prettyprint">myTopicAPI</code> object that you provide per vault-name, may be replaced with <code class="prettyprint">true</code> in order to get all default
behaviors for that vault type. Read about &ldquo;Advanced usage&rdquo; to see how you can set up these topic APIs with custom
behaviors.</p>

<p>Finally, you may optionally provide an <code class="prettyprint">afterLoad</code> function that takes 3 arguments: <code class="prettyprint">state</code>, <code class="prettyprint">value</code> and <code class="prettyprint">cb</code>.
When you provide this function, each database load will call this function before returning to userland code. That gives
you (for example) the opportunity to perform document migration. The document can be found in <code class="prettyprint">value.data</code>, but you will
have to make sure yourself that it&rsquo;s deserialized before you read from it. You can do this by calling
<code class="prettyprint">value.setEncoding(&#39;live&#39;);</code>. After this, <code class="prettyprint">value.data</code> will contain the unserialized document. You could store a
document schema version number in this document and when you notice it falls behind, migrate the document to the latest
schema. When you&rsquo;re done handling the <code class="prettyprint">afterLoad</code> logic, you <strong>must</strong> call <code class="prettyprint">cb</code> to continue. If you pass an error to
<code class="prettyprint">cb</code>, the <code class="prettyprint">get()</code> or <code class="prettyprint">mget()</code> call that the load originated from will receive that error. It is up to you to log it.</p>

<p>In order to keep your configuration maintainable, it makes a lot of sense to
categorize your topics. Imagine for example the following configuration:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">dynamicTopic</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">index</span><span class="p">:</span> <span class="nx">index</span><span class="p">,</span> <span class="na">vaults</span><span class="p">:</span> <span class="p">{</span> <span class="na">mysql</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">memcached</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">staticTopic</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">vaults</span><span class="p">:</span> <span class="p">{</span> <span class="na">file</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">};</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="nx">dynamicTopic</span><span class="p">([</span><span class="s1">'id'</span><span class="p">]);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">inventory</span> <span class="o">=</span> <span class="nx">dynamicTopic</span><span class="p">([</span><span class="s1">'playerId'</span><span class="p">]);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">cards</span> <span class="o">=</span> <span class="nx">dynamicTopic</span><span class="p">([</span><span class="s1">'playerId'</span><span class="p">]);</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">cardDefinitions</span> <span class="o">=</span> <span class="nx">staticTopic</span><span class="p">();</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">itemDefinitions</span> <span class="o">=</span> <span class="nx">staticTopic</span><span class="p">();</span>
</code></pre>
<h2 id="using-the-server-api">Using the Server API</h2>

<p>You can always access the archivist through <code class="prettyprint">state.archivist</code>. If you really need to make your own
instance, you can use the following:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">archivist</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">archivist</span><span class="p">.</span><span class="nx">Archivist</span><span class="p">();</span>
</code></pre>
<p>The following API documentation should tell you how to store, read, delete data and how to set their
expiration time. Keep in mind that there could be vault types that do not support particular
operations. A typical one would be <code class="prettyprint">touch</code>, which is generally not well supported. But even other
operations may trigger an error. For example, when trying to <code class="prettyprint">write</code> to a read-only vault, or
opposite.</p>

<h3 id="adding-new-data">Adding new data</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">mediaType</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">expirationTime</span><span class="p">);</span>
</code></pre>
<p>Marks the <code class="prettyprint">data</code> you pass as something you want to store in your vaults, applying the given <code class="prettyprint">topic</code>
and <code class="prettyprint">index</code>. If no <code class="prettyprint">mediaType</code> is given, archivist will try to detect one. If no <code class="prettyprint">encoding</code> is
given, archivist will try to detect one. If you want to store this data for a limited time, you can
pass an <code class="prettyprint">expirationTime</code> (unix timestamp in seconds). If a value already existed, you should expect
this call to fail.</p>

<p>This call is very similar to a combination of <code class="prettyprint">archivist.exists</code> followed by <code class="prettyprint">archivist.set</code> when
the <code class="prettyprint">exists</code> value is <code class="prettyprint">false</code>.</p>

<h3 id="getting-data">Getting data</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>Reads data from all vaults configured for this topic, returning the first successful read. Read
errors are considered fatal, and you should abort your operations. However, if a vault is responsive
but simply doesn&rsquo;t hold the value you requested, the next vault in line may still be able to deliver.
If a value has already been read or written to before in this archivist instance, that value has
been cached and will be returned.</p>

<p>The following options are available to you:</p>

<ul>
<li><code class="prettyprint">optional</code>: (boolean, default: false) Indicates whether it&rsquo;s considered an error if data is not
found in any of the vaults.</li>
<li><code class="prettyprint">mediaTypes</code>: (array, default: <code class="prettyprint">[&#39;application/x-tome&#39;, &#39;application/octet-stream&#39;]</code>) Indicates
that you only accept these media types, in the given order of priority. If data of another media
type is read, a conversion attempt will be made (eg: JSON to Tome).</li>
<li><code class="prettyprint">encodings</code>: (array, default: <code class="prettyprint">[&#39;live&#39;]</code>) Indicates that you only accept these encodings, in the
given order of priority. If data of another encoding is read, a conversion attempt will be made
(eg: JavaScript object to utf8 JSON).</li>
</ul>

<p>This options object is not required, and your callback may be passed as the third argument.</p>

<h4 id="multi-get">Multi-get</h4>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">mget</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">multiData</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>For multi-get operations, please use <code class="prettyprint">mget</code>. The options are identical to and just as optional as in
the <code class="prettyprint">get</code> method. There are two supported <code class="prettyprint">queries</code> formats: the array and the map. In both cases,
the result will map to the input.</p>

<h5 id="array-style-queries">Array style queries</h5>

<h6 id="queries">queries</h6>
<pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"players"</span><span class="p">,</span><span class="w"> </span><span class="s2">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"players"</span><span class="p">,</span><span class="w"> </span><span class="s2">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"def"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"players"</span><span class="p">,</span><span class="w"> </span><span class="s2">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hij"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h6 id="multidata">multiData</h6>

<p>The result is an array where the output order matches the input order:</p>
<pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bob"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="err">undefined</span><span class="p">,</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Harry"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h5 id="object-map-style-queries">Object map style queries</h5>

<h6 id="queries">queries</h6>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"a"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"players"</span><span class="p">,</span><span class="w"> </span><span class="s2">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abc"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="s2">"b"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"players"</span><span class="p">,</span><span class="w"> </span><span class="s2">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"def"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="s2">"c"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"players"</span><span class="p">,</span><span class="w"> </span><span class="s2">"index"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hij"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h6 id="multidata">multiData</h6>

<p>The result is an object map where the keys match the input keys:</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"a"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bob"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="s2">"b"</span><span class="p">:</span><span class="w"> </span><span class="err">undefined</span><span class="p">,</span><span class="w">
    </span><span class="s2">"c"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Harry"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h3 id="testing-existence-of-data">Testing existence of data</h3>
<pre class="highlight javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">exists</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>This checks if the value exists in a vault or not. The <code class="prettyprint">exists</code> boolean will reflect the result of
this test.</p>

<h3 id="overwriting-data">Overwriting data</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">mediaType</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">expirationTime</span><span class="p">);</span>
</code></pre>
<p>Marks the <code class="prettyprint">data</code> you pass as something you want to write to all your vaults, applying the given
<code class="prettyprint">topic</code> and <code class="prettyprint">index</code>. If no <code class="prettyprint">mediaType</code> is given, archivist will apply the one it already knows
about this value (if a <code class="prettyprint">get</code> or <code class="prettyprint">add</code> happened before), else it will try to detect one. If no
<code class="prettyprint">encoding</code> is given, archivist will try to detect one. If you want to store this data for a limited
time, you can pass an <code class="prettyprint">expirationTime</code> (unix timestamp).</p>

<p>If a vault allows for diff-logic to occur, and the data passed allows diffs to be read, this will be
used.</p>

<p>For certain types of data, like Tomes, you do not have to call this function. Whenever you change
a Tome&rsquo;s contents, it will call <code class="prettyprint">set</code> automatically for you.</p>

<h3 id="deleting-data">Deleting data</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
</code></pre>
<p>Marks data pointed to by <code class="prettyprint">topic</code> and <code class="prettyprint">index</code> as something you want to delete. A subsequent <code class="prettyprint">get</code>
will not yield any data.</p>

<h3 id="setting-an-expiration-time">Setting an expiration time</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">touch</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">expirationTime</span><span class="p">);</span>
</code></pre>
<p>Marks data with a new expiration time (unix timestamp in seconds).</p>

<h3 id="finding-data">Finding data</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">partialIndex</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">arrayOfIndexes</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>Returns an array of indexes on the given topic matching the partial index you provide. A partial
index is the same as a normal index object, except you can leave out properties.
The options object is not required, and your callback may be passed as the third argument.</p>

<p>You can, for example, query for all players in the game by using an empty partial index:</p>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// A full index for the "players" topic contains only the "id" property.</span>

<span class="nx">archivist</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="s1">'player'</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">indexes</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* indexes is now [{ id: 5 }, { id: 20 }, ...] */</span>
<span class="p">});</span>
</code></pre>
<p>Or for all players that are in a guild:</p>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// A full index for the "guildPlayers" topic consists of "guildId" and "userId"</span>

<span class="nx">archivist</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="s1">'guildPlayers'</span><span class="p">,</span> <span class="p">{</span> <span class="na">guildId</span><span class="p">:</span> <span class="s1">'abc'</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">indexes</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* indexes is now [{ guildId: 'abc', userId: 5 }, { guildId: 'abc', userId: 20 }, ...] */</span>
<span class="p">});</span>
</code></pre>
<p>You may pass the following options:</p>

<p><strong>sort</strong></p>

<p>An array of sorting rules. Each rule has the format:
<code class="prettyprint">json
{ &quot;name&quot;: &quot;fieldName in the index&quot;, &quot;direction&quot;: &quot;asc or desc&quot; }
</code></p>

<p>You may give multiple of these in order of importance. Use <code class="prettyprint">direction</code> to specify ascending or
descending sort-order.</p>

<p><strong>chunk</strong></p>

<p>An array of the format <code class="prettyprint">[start, length]</code> where both values are integers and <code class="prettyprint">length</code> is optional.
This will limit the sorted result to the indexes starting at <code class="prettyprint">start</code> (counts from 0) until
<code class="prettyprint">start + length</code>. This allows for paginating your results.</p>

<p>Options example (sorted by id (descending), page 3 with 10 results per page):</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"sort"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w"> </span><span class="s2">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"desc"</span><span class="w"> </span><span class="p">}],</span><span class="w">
    </span><span class="s2">"chunk"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h3 id="distributing-changes-to-all-vaults">Distributing changes to all vaults</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">distribute</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">distributeError</span><span class="p">,</span> <span class="nx">operationErrors</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>This takes all the queued up operations (add, set, del, touch) and executes them on each of
the relevant vaults. This distribution is automatically done by the <code class="prettyprint">state</code> object in MAGE when it
closes without errors, so you should never have to call this yourself.</p>

<h3 id="manually-adding-data-to-the-archivist-memory-cache">Manually adding data to the archivist memory cache</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">addToCache</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">mediaType</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">);</span>
</code></pre>
<p>This manually adds a value to the archivist cache based on its topic and index, so that next
calls to <code class="prettyprint">archivist.get</code> won&rsquo;t hit the database but pull the entry from memory. This can be used
to cache a large amount of entries retrieved from the database that may be more efficient to retrieve
in a single query instead of many <code class="prettyprint">archivist.get</code> calls.</p>

<p>For example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mysql</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">'SELECT * FROM topicTable WHERE type = ?'</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// error</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="c1">// cache the row</span>
        <span class="nx">state</span><span class="p">.</span><span class="nx">archivist</span><span class="p">.</span><span class="nx">addToCache</span><span class="p">(</span><span class="s1">'topic'</span><span class="p">,</span> <span class="p">{</span> <span class="na">index</span><span class="p">:</span> <span class="nx">row</span><span class="p">.</span><span class="nx">index</span> <span class="p">},</span> <span class="nx">row</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">,</span> <span class="nx">row</span><span class="p">.</span><span class="nx">encoding</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// now run some heavy computation that uses archivist.get on that data</span>
    <span class="nx">heavyComputation</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<h2 id="client-api">Client API</h2>

<p>The archivist is exposed on the browser through a MAGE module called &ldquo;archivist&rdquo;. You can use it
like any other built-in module:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">useModules</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="s1">'archivist'</span><span class="p">);</span>
</code></pre>
<p>You can now read from and write to the vaults by calling using the APIs described below. It is
important to understand that the Archivist client keeps a cache in memory. When you do a get or mget
operation, and the value has already been read or set before, you will receive the version from the
cache (see the <code class="prettyprint">maxAge</code> option below to see how you can control this behavior).</p>

<p>The <strong>read methods</strong> available are identical to the server variation:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
<span class="nx">archivist</span><span class="p">.</span><span class="nx">mget</span><span class="p">(</span><span class="nx">queries</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
<span class="nx">archivist</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">partialIndex</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">indexes</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>For <code class="prettyprint">get</code> and <code class="prettyprint">mget</code> the client enables one extra read option that the server doesn&rsquo;t have:</p>

<ul>
<li>maxAge: A number in seconds. If a value is available in cache, but was set longer ago than this
many seconds, it will not be used. That means that setting maxAge to <code class="prettyprint">0</code> will always bypass the
cache.</li>
</ul>

<p>These are the <strong>data mutation</strong> operations, again, identical to the server variation:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">archivist</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">mediaType</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">expirationTime</span><span class="p">);</span>
<span class="nx">archivist</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">mediaType</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">expirationTime</span><span class="p">);</span>
<span class="nx">archivist</span><span class="p">.</span><span class="nx">touch</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">expirationTime</span><span class="p">);</span>
<span class="nx">archivist</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
<span class="nx">archivist</span><span class="p">.</span><span class="nx">distribute</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="p">});</span>
</code></pre>
<p>Unlike on the server, where <code class="prettyprint">distribute()</code> is called by <code class="prettyprint">State</code> objects, on the client-side, you
have to do it yourself. Consider the user experience, and call <code class="prettyprint">distribute()</code> when you have made a
batch of changes and want to send them.</p>

<h2 id="advanced-vault-usage">Advanced vault usage</h2>

<h3 id="direct-access-to-a-vaults-native-api">Direct access to a vault&rsquo;s native API</h3>

<p>If you want to access a vault directly, you can ask the archivist for the instance. Often a vault
will expose its underlying library on a <code class="prettyprint">.client</code> property. Depending on if you want to list, read
or write data, you can call:</p>

<ul>
<li><code class="prettyprint">archivist.getListVault(vaultName);</code></li>
<li><code class="prettyprint">archivist.getReadVault(vaultName);</code></li>
<li><code class="prettyprint">archivist.getWriteVault(vaultName);</code></li>
</ul>

<p>For more information on the APIs exposed by each vault, please refer to their documentation.</p>

<h3 id="writing-your-own-topic-apis">Writing your own Topic APIs</h3>

<p>Topic APIs are a collection of APIs that enable a vault to get data to and from its underlying
data store. The total set of APIs is limited, and each vault type has its own required subset. For
more information on the specifics per vault type, please refer to their documentation.</p>

<p>You can integrate these in the way explained in the &ldquo;Configure your topics&rdquo; paragraph. Keep in mind
that whenever you choose to implement one of the APIs for a topic, the non-implemented ones will
still exist in their default implementations.</p>

<p>The following APIs can be implemented.</p>

<h4 id="serializing-data">Serializing data</h4>

<p>The serialize method receives a <code class="prettyprint">VaultValue</code> instance which can contain data, in an <code class="prettyprint">encoding</code>,
tagged with a <code class="prettyprint">MediaType</code> and aware of its <code class="prettyprint">topic</code> and <code class="prettyprint">index</code>. When preparing data to be stored
into a vault, the serialize method may have to change the encoding to better fit the requirements of
the vault, and even return completely different/altered data (imagine prepending header/meta
information to the real data). Finally, the returned data is used by the vault.</p>

<p>Example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">serialize</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">([</span><span class="s1">'utf8'</span><span class="p">,</span> <span class="s1">'buffer'</span><span class="p">]).</span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<h4 id="deserializing-data">Deserializing data</h4>

<p>The deserialize method receives the data as it was returned by the vault. It has the duty to
initialize the passed <code class="prettyprint">VaultValue</code> instance with that data, in the right <code class="prettyprint">encoding</code> and <code class="prettyprint">MediaType</code>.
If encoding and/or MediaType are omitted, they will be guessed by the underlying system. This can be
acceptable when the data is returned in deserialized form by the vault.</p>

<p>Example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">deserialize</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">initWithData</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<h4 id="generating-a-key">Generating a key</h4>

<p>Every vault needs a key function to access data. Generally, the key function will take the <code class="prettyprint">topic</code>
and <code class="prettyprint">index</code> and turn those into something that is appropriate for the vault. This can be a string
(eg. in the case of memcached), but also a rich object (eg. in the case of MySQL). Think of the key
as the minimal information required to find a piece of data in a vault.</p>

<p>Example (typical SQL):</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">key</span><span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="na">table</span><span class="p">:</span> <span class="nx">topic</span><span class="p">,</span>  <span class="c1">// topic is used as the table name</span>
        <span class="na">pk</span><span class="p">:</span> <span class="nx">index</span>      <span class="c1">// { columnName: value }</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre>
<h4 id="selecting-a-shard">Selecting a shard</h4>

<p>The shard method is similar to the key method, except it doesn&rsquo;t pinpoint the exact location of
data, but a general location, in order to facilitate sharding. A good example is the Client vault,
which needs to emit data changes to different users based on certain very specific information.
Incidentally, this is currently the <em>only</em> Topic API method you <em>have to</em> implement yourself.</p>

<p>Example (Client):</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">shard</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// the Client shard is one or more actor IDs</span>

    <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">actorId</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Example (Client, multiple actors):</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">shard</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// the Client shard is one or more actor IDs</span>

    <span class="nx">value</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">'live'</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">actorId</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">friendIds</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<p>Example (Client, static data for all actors):</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">function</span> <span class="nx">shard</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
          <h1 id="vaults">Vaults</h1>

<p>Vaults are used by Archvist to store data.</p>

          <h2 id="file-vault">File vault</h2>

<p>For static content, it often makes a lot of sense to store your files on disk, in your repository.
The &ldquo;file&rdquo; vault makes this possible.</p>

<h3 id="configuration">Configuration</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">type</span><span class="pi">:</span> <span class="s">file</span>
<span class="na">config</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">./filevault</span>
    <span class="na">disableExpiration</span><span class="pi">:</span> <span class="s">true</span>  <span class="c1"># optional (default: false)</span>
</code></pre>
<p>If your application does not need the file vault to support expirationTime and the <code class="prettyprint">touch</code> command,
you may turn it off by adding <code class="prettyprint">disableExpiration: true</code> to your configuration. This can be useful,
because when your filevault holds many files, file expiration tests can take multiple seconds during
the booting of your app. Use with caution.</p>

<h3 id="bootstrapping-a-file-vault">Bootstrapping a file vault</h3>

<p>This is supported through the <code class="prettyprint">./game archivist-create</code> CLI command. This will create your empty
folder. Running <code class="prettyprint">./game archivist-drop</code> will destroy it.</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">fs.readdir(config.path);</code></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">fs.readFile(&#39;myfile.filevault&#39; and &#39;myfile.json&#39;);</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">fs.writeFile(&#39;myfile.filevault&#39; and &#39;myfile.json&#39;);</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">fs.writeFile(&#39;myfile.filevault&#39; and &#39;myfile.json&#39;);</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">fs.readFile(&#39;myfile.filevault&#39;); fs.writeFile(&#39;myfile.filevault&#39;);</code></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">fs.readFile(&#39;myfile.filevault&#39;); fs.unlink(&#39;myfile.filevault&#39; and &#39;myfile.json&#39;);</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td></td>
<td><code class="prettyprint">topic#prop=value&amp;prop=value&amp;...</code> (url encoded)</td>
</tr>
<tr>
<td><code class="prettyprint">parseKey(path)</code></td>
<td></td>
<td>from key to <code class="prettyprint">{ topic: &#39;&#39;, index: { prop: value } }</code></td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td>{ meta: { mediaType: &ldquo;, expirationTime: 0, ext: &lsquo;.json&rsquo; }, content: Buffer }</td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>from serialized to VaultValue with mediaType and expirationTime</td>
</tr>
</tbody></table>

          <h2 id="memory-vault">Memory vault</h2>

<p>For static content, it often makes a lot of sense to keep your files in memory for quick access.
The &ldquo;memory&rdquo; vault makes this possible. The Memory vault keeps data serialized in memory. That
allows synchronization to clients to happen without any (de)serialization steps, saving you precious
CPU and garbage collection cycles.</p>

<p><strong>A word of warning</strong></p>

<p>Because the memory vault only lives in JavaScript memory, it does not transcend into other
processes. That means that you can not depend on it to store data for you in one worker, and expect
it to be accessible by another. That is obviously also true between multiple servers.</p>

<h3 id="configuration">Configuration</h3>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"memory"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The memory vault doesn&rsquo;t use any special configuration.</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">for (var trueName in cache) { }</code></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">deserialize(cache[trueName(fullIndex, topic)])</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">cache[trueName(fullIndex, topic)] = serialize(data)</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">cache[trueName(fullIndex, topic)] = serialize(data)</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">setTimeout()</code></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">delete cache[trueName(fullIndex, topic)]</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td></td>
<td>rumplestiltskin trueName</td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td>VaultValue to internal MemoryData object</td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>from MemoryData to VaultValue</td>
</tr>
</tbody></table>

          <h2 id="redis-vault">Redis vault</h2>

<p>The node-redis module is supported through the built-in &ldquo;redis&rdquo; vault type.</p>

<h3 id="configuration">Configuration</h3>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"redis"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">6379</span><span class="p">,</span><span class="w">
        </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"options to pass"</span><span class="p">:</span><span class="w"> </span><span class="s2">"to node-redis"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="s2">"prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"prefix for all your keys"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The <code class="prettyprint">options</code> object is described in the <a href="https://npmjs.org/package/redis">node-redis readme</a>.
Both <code class="prettyprint">options</code> and <code class="prettyprint">prefix</code> are optional. The option <code class="prettyprint">return_buffers</code> is turned on by default by the
Archivist, because the default serialization will prepend values with meta data (in order to
preserve mediaType awareness).</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">redis.get()</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">redis.set(&#39;NX&#39;)</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">redis.set()</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">redis.expire()</code></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">redis.del()</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td></td>
<td>&ldquo;topic/indexProp:indexValue/indexProp:indexValue/&hellip;&rdquo; (index is sorted)</td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td>a header containing mediaType followed by a <code class="prettyprint">Buffer</code> of the data</td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>parses data from the default <code class="prettyprint">serialize</code> function</td>
</tr>
</tbody></table>

          <h2 id="mysql-vault">MySQL vault</h2>

<p>The node-mysql module is supported through the built-in &ldquo;mysql&rdquo; vault type.</p>

<h3 id="configuration">Configuration</h3>

<h4 id="url-based-config">URL based config</h4>
<pre class="highlight yaml tab-yaml"><code>        <span class="na">mysql</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">mysql</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mysql://user:password@host/db?extraConfig=extraValue"</span>
</code></pre>
<p>This URL format is documented in the <a href="https://npmjs.org/package/mysql">node-mysql readme</a>.</p>

<h4 id="object-based-config">Object based config</h4>
<pre class="highlight yaml tab-yaml"><code>        <span class="na">mysql</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">mysql</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="na">options</span><span class="pi">:</span>
                    <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">myhost"</span>
                    <span class="na">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">myuser"</span>
                    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mypassword"</span>
                    <span class="na">database</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mydb"</span>
</code></pre>
<p>The available connection options are documented in the <a href="https://github.com/felixge/node-mysql#connection-options">node-mysql readme</a>.
For pool options please look at <a href="https://github.com/felixge/node-mysql#pool-options">Pool options</a>.</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">SELECT FROM table WHERE partialIndex</code></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">SELECT FROM table WHERE fullIndex</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">INSERT INTO table SET ?</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">INSERT INTO table SET ? ON DUPLICATE KEY UPDATE ?</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">DELETE FROM table WHERE fullIndex</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td></td>
<td><code class="prettyprint">{ table: topic, pk: index }</code></td>
</tr>
<tr>
<td><code class="prettyprint">parseKey(mysqlKey)</code></td>
<td></td>
<td><code class="prettyprint">{ topic: key.table, index: key.pk }</code></td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td><code class="prettyprint">{ value: utf8orBufferFromValue, mediaType: value.mediaType }</code></td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>parses row.value and row.mediaType into Value</td>
</tr>
</tbody></table>

<h3 id="bootstrapping-a-database">Bootstrapping a database</h3>

<p>This is supported through the <code class="prettyprint">./game archivist-create</code> CLI command. This will create your empty
database. Tables must be created through migration scripts. Running <code class="prettyprint">./game archivist-drop</code> will
drop the entire database.</p>

<h3 id="schema-migrations">Schema migrations</h3>

<p>Archivist allows for <a href="../../Migrations.md">migrations</a>, and the MySQL vault supports
this.</p>

<h3 id="helper-functions">Helper functions</h3>

<p>Currently we have the following helper functions for MySQL database management:
 * <code class="prettyprint">createDatabase(cb)</code>: This is used by <code class="prettyprint">archivist-create</code> to create configured databases. You rarely need to call this
   yourself.
 * <code class="prettyprint">dropDatabase(cb)</code>:  This is used by <code class="prettyprint">archivist-drop</code> to destroy configured databases. You rarely need to call this
   yourself.
 * <code class="prettyprint">createTable(tableName, columns, cb)</code>: This can be used to create tables inside migration scripts as outlined in the
   <a href="../../Migrations.md">migrations</a> document.
 * <code class="prettyprint">dropTable(tableName, cb)</code>: This can be used to drop tables inside migration scripts as outlined in the
   <a href="../../Migrations.md">migrations</a> document.</p>

<h3 id="how-to-set-up-your-mysql-tables">How to set up your MySQL tables</h3>

<p>Queries against your database are done through a combination of the generated keys and serialized
values. A generated key must yield a table name and a primary key. A serialized value must yield a
number of column names with their respective values.</p>

<p>The default topic API that comes with this vault behaves as can seen in the table above. This means
that for example, given a topic <code class="prettyprint">people</code> and index <code class="prettyprint">{ personId: 1 }</code>, the following table should
exist:</p>
<pre class="highlight sql tab-sql"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">people</span> <span class="p">(</span>
  <span class="n">personId</span> <span class="n">INT</span> <span class="n">UNSIGNED</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">value</span> <span class="n">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">mediaType</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">personId</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span>
</code></pre>
<blockquote>
<p>Please note that you should probably change column types, as this is really just an example.
Also keep in mind character sets (utf8_bin is usually a good choice) and data type ranges. For
more information on data types, please refer to the
<a href="http://dev.mysql.com/doc/refman/5.5/en/data-types.html">MySQL documentation</a>.</p>
</blockquote>

<p>If you want to change how this information is stored, by adding columns, etc, you can overload the
serializer method to do so. For example, consider the following example if you want to add a
timestamp to a <code class="prettyprint">lastChanged INT UNSIGNED NOT NULL</code> column.</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">vaults</span><span class="p">.</span><span class="nx">mysql</span><span class="p">.</span><span class="nx">serialize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="na">value</span><span class="p">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">([</span><span class="s1">'utf8'</span><span class="p">,</span> <span class="s1">'buffer'</span><span class="p">]).</span><span class="nx">data</span><span class="p">,</span>
        <span class="na">mediaType</span><span class="p">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">,</span>
        <span class="na">lastChanged</span><span class="p">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre>
          <h2 id="memcached-vault">Memcached vault</h2>

<p>The <a href="https://npmjs.org/package/memcached">node-memcached</a> module is supported through the built-in
&ldquo;memcached&rdquo; vault type.</p>

<h3 id="using-the-memcached-vault-for-couchbase-clusters">Using the Memcached vault for Couchbase clusters</h3>

<p>Please note that the Memcached vault <strong>can be used</strong> to interact with Couchbase clusters and
buckets (it does not require you to change the bucket type to &ldquo;memcached&rdquo;). Alternatively, the
<a href="../couchbase/Readme.md">Couchbase vault</a> may be chosen for that, but at this time the library it is
based on (<a href="https://npmjs.org/package/couchbase">node-couchbase</a>) is a less mature and less tested
library. That should change over time.</p>

<h3 id="configuration">Configuration</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">myvault</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">memcached</span>
    <span class="na">config</span><span class="pi">:</span>
        <span class="na">servers</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">1.2.3.4:11211"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">1.2.3.5:11411"</span>
        <span class="na">options</span><span class="pi">:</span>
            <span class="na">foo</span><span class="pi">:</span> <span class="s">bar</span>
        <span class="na">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">prefix</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">all</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">keys"</span>
</code></pre>
<p>The usage of the <code class="prettyprint">servers</code> and <code class="prettyprint">options</code> properties are described in the
<a href="https://npmjs.org/package/memcached">node-memcached readme</a>. Both <code class="prettyprint">options</code> and <code class="prettyprint">prefix</code> are
optional.</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">memcached.get()</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">memcached.add()</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">memcached.set()</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">memcached.touch()</code></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">memcached.del()</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td></td>
<td>&ldquo;topic/indexProp:indexValue/indexProp:indexValue/&hellip;&rdquo; (index is sorted)</td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td>forced to <code class="prettyprint">live</code> encoding, node-memcached will serialize and flag type</td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>received in <code class="prettyprint">live</code> encoding</td>
</tr>
</tbody></table>

          <h2 id="couchbase-vault">Couchbase vault</h2>

<p>The <a href="https://npmjs.org/package/couchbase">node-couchbase</a> module is supported through the built-in
&ldquo;couchbase&rdquo; vault type. It supports sharding by creating hashes on strings that your <code class="prettyprint">shard</code>
function may provide.</p>

<p>Alternatively, you can also use the <a href="../memcached/Readme.md">Memcached vault</a> which is based on
<a href="https://npmjs.org/package/memcached">node-memcached</a>.</p>

<p>Read more on Couchbase at <a href="http://www.couchbase.com/couchbase-server/overview">couchbase.com</a>.</p>

<h3 id="sharding">Sharding</h3>

<p>The Couchbase vault supports sharding. That is a great way to cluster user data onto a single
vbucket. You can implement this by giving your topic API a shard function, and returning a string or
number to shard on (called our hash-key). In many cases, this will be a user ID. This hash key may
not come from the data you are writing, because we need to be able to generate this value on-read as
well, before we have data in our hands.</p>

<p>Example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">index</span><span class="p">:</span> <span class="p">[</span><span class="s1">'userId'</span><span class="p">],</span>
    <span class="na">vaults</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">couchbase</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">shard</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<h3 id="flags">Flags</h3>

<p>Couchbase allows one to set 4 bytes of meta information (flags) with each document that will be
returned when you retrieve it. People generally use these flags to store the data type. The
Couchbase vault does this too. Two flag styles have been implemented, and through configuration you
can switch between them.</p>

<p>The default flag style turns the file extension that goes with the media type into a binary 4-byte
representation. For example: <code class="prettyprint">txt</code>, <code class="prettyprint">json</code>, <code class="prettyprint">tome</code>, <code class="prettyprint">bin</code>.</p>

<p>There is an alternative flag style called <code class="prettyprint">node-memcached</code>. Use this if you want to be compatible
with the Memcached vault.</p>

<h3 id="switching-between-memcached-and-couchbase-vaults">Switching between Memcached and Couchbase vaults</h3>

<p>You can do this, but there are two limitations you must be aware of. Please ask your system
operators for advice. The two issues to take into account are the following.</p>

<h4 id="flag-style">Flag style</h4>

<p>If you roll out this vault and you want to be able to switch to a memcached vault some time in the
future, you need to make sure you set <code class="prettyprint">flagStyle</code> to <code class="prettyprint">node-memcached</code>. If you do not do this, the
file types of your documents will not match up once you make the switch! The reason for this is that
we cannot control what the flags look like when using <code class="prettyprint">node-memcached</code>, as it&rsquo;s built-in.</p>

<h4 id="sharding">Sharding</h4>

<p>The Couchbase vault supports sharding. That is a great way to cluster user data onto a single
vbucket. Please note however, that <code class="prettyprint">node-memcached</code> using Moxi will not be able to apply the same
sharding logic. Once you start sharding, you cannot switch back to a Memcached vault.</p>

<h3 id="configuration">Configuration</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">type</span><span class="pi">:</span> <span class="s">couchbase</span>
<span class="na">config</span><span class="pi">:</span>
    <span class="na">options</span><span class="pi">:</span>
        <span class="na">user</span><span class="pi">:</span> <span class="s">Administrator</span>         <span class="c1"># optional, usually not required</span>
        <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">password"</span>        <span class="c1"># optional, usually not required</span>
        <span class="na">host</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">localhost:8091"</span> <span class="pi">]</span>  <span class="c1"># optional</span>
        <span class="na">bucket</span><span class="pi">:</span> <span class="s">default</span>             <span class="c1"># optional</span>
    <span class="na">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">prefix</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">all</span><span class="nv"> </span><span class="s">keys"</span>   <span class="c1"># eg: "bob/"</span>
    <span class="na">flagStyle</span><span class="pi">:</span> <span class="s">default</span>              <span class="c1"># "default" or "node-memcached"</span>
</code></pre>
<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">couchbase.get()</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">couchbase.add()</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">couchbase.set()</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">couchbase.touch()</code></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">couchbase.remove()</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td></td>
<td>&ldquo;topic/indexProp:indexValue/indexProp:indexValue/&hellip;&rdquo; (index is sorted)</td>
</tr>
<tr>
<td><code class="prettyprint">shard(value)</code></td>
<td></td>
<td>undefined</td>
</tr>
<tr>
<td><code class="prettyprint">createFlags(mediaType, flagStyle)</code></td>
<td></td>
<td>either <code class="prettyprint">default</code> or <code class="prettyprint">node-memcached</code> compatible style flag creation based on mediaType</td>
</tr>
<tr>
<td><code class="prettyprint">parseFlags(flags, flagStyle)</code></td>
<td></td>
<td>will turn both <code class="prettyprint">default</code> and <code class="prettyprint">node-memcached</code> style flags into a media type</td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td>returns a <code class="prettyprint">utf8</code> representation of <code class="prettyprint">value.data</code></td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, mediaType, value)</code></td>
<td></td>
<td>writes <code class="prettyprint">data</code> and <code class="prettyprint">mediaType</code> into <code class="prettyprint">value</code></td>
</tr>
</tbody></table>

<h3 id="views-migration">Views Migration</h3>

<p>Archivist allows for <a href="../../SchemaMigrations.md">schema migrations</a>, and the Couchbase vault
supports this. This should however only be used to migrate document views.</p>

<p>Also as couchbase only allows for 20MB of data per key and as this feature stores all the version
data into a single key, please write short concise reports to avoid breaking that limit.</p>

          <h2 id="dynamodb-vault">DynamoDB vault</h2>

<p>Excerpt from Amazon:</p>

<blockquote>
<p>Amazon DynamoDB is a fully managed NoSQL database service that provides fast and predictable
performance with seamless scalability. If you are a developer, you can use Amazon DynamoDB to
create a database table that can store and retrieve any amount of data, and serve any level of
request traffic. Amazon DynamoDB automatically spreads the data and traffic for the table over
a sufficient number of servers to handle the request capacity specified by the customer and the
amount of data stored, while maintaining consistent and fast performance. All data items are stored
on Solid State Disks (SSDs) and are automatically replicated across multiple Availability Zones
in a Region to provide built-in high availability and data durability.</p>
</blockquote>

<h3 id="configuration">Configuration</h3>

<p>For production, use a config similar to this:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">dynamodb</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dynamodb"</span>
    <span class="na">config</span><span class="pi">:</span>
        <span class="na">accessKeyId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">The</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">ID</span><span class="nv"> </span><span class="s">provided</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">Amazon"</span>
        <span class="na">secretAccessKey</span><span class="pi">:</span> <span class="s2">"</span><span class="s">The</span><span class="nv"> </span><span class="s">secret</span><span class="nv"> </span><span class="s">ID</span><span class="nv"> </span><span class="s">provided</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">Amazon"</span>
        <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">A</span><span class="nv"> </span><span class="s">valid</span><span class="nv"> </span><span class="s">region.</span><span class="nv"> </span><span class="s">Refer</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Amazon</span><span class="nv"> </span><span class="s">doc</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">ask</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">sysadmin.</span><span class="nv"> </span><span class="s">Asia</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">ap-northeast-1"</span>
</code></pre>
<p>For a development environment running it&rsquo;s own DynamoDB, use this:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">dynamodb</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">dynamodb"</span>
    <span class="na">config</span><span class="pi">:</span>
        <span class="c1"># accessKeyId and region are used to generate the database name, secret will be ignored</span>
        <span class="na">accessKeyId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Your</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">good</span><span class="nv"> </span><span class="s">idea</span><span class="nv"> </span><span class="s">here"</span>
        <span class="na">secretAccessKey</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Any</span><span class="nv"> </span><span class="s">value,</span><span class="nv"> </span><span class="s">will</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">ignored"</span>
        <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">And</span><span class="nv"> </span><span class="s">here</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">game/project</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">good</span><span class="nv"> </span><span class="s">idea"</span>
        <span class="na">endpoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hostname:port"</span>
        <span class="na">sslEnabled</span><span class="pi">:</span> <span class="s">false</span>
</code></pre>
<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">DynamoDB.getItem</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">DynamoDB.putItem</code> with <code class="prettyprint">Expect.exists = false</code> set to the index keys</td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">DynamoDB.putItem</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">DynamoDB.deleteItem</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(index)</code></td>
<td></td>
<td><code class="prettyprint">{ index1: { &#39;S&#39;: &#39;value1&#39; }, index2: ... }</code></td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td><code class="prettyprint">{ data: { &#39;S&#39;: utf8FromValue }, mediaType: { &#39;S&#39;: value.mediaType } }</code></td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>parses row.data and row.mediaType into Value</td>
</tr>
<tr>
<td><code class="prettyprint">transformError(value, error)</code></td>
<td></td>
<td><code class="prettyprint">if (error.code === knownError) return new Error(&#39;Comprehensive message&#39;)</code></td>
</tr>
<tr>
<td><code class="prettyprint">consistent</code></td>
<td></td>
<td>A boolean, default to true</td>
</tr>
</tbody></table>

<h3 id="reads-consistency">Reads consistency</h3>

<p>By default reads made directly through the DynamoDB vault are eventually consistent, but for calls
made through archivist the consistency is set to strongly consistent by default in the API.
Strongly consistent calls are more expensive and slower than eventually consistent ones, so if you
feel that your table doesn&rsquo;t need to be strongly consistent, feel free to change the &ldquo;consistent&rdquo;
boolean in the topic DynamoDB API to false.</p>

<h3 id="schema-migrations">Schema migrations</h3>

<p>Archivist allows for <a href="../../SchemaMigrations.md">schema migrations</a>, and the DynamoDB vault supports
this.</p>

<p>When writing migration scripts, please refer to
<a href="http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB.html">Class: AWS.DynamoDB</a> for more
details on how to use the DynamoDB class exposed by the vault as <code class="prettyprint">vault.dynamodb</code>. For most tables
you will only need to create the indexes (at least 1 Hash index, 1 optional Range index and up to 5
secondary indexes), all other columns are created dynamically at insert time by DynamoDB.</p>

<p>See <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DataModel.html">Amazon DynamoDB Data Model</a>
for more details on how you should choose your Hash and Range indexes.</p>

<p>For the mandatory <code class="prettyprint">ProvisionedThroughput</code> map in the createTable object, values for production
should be 100 <code class="prettyprint">ReadCapacityUnits</code> and 20 <code class="prettyprint">WriteCapacityUnits</code>, then please ask the game&rsquo;s sysadmins
to take care of updating those values manually to more appropriate numbers. This has a direct impact
on the price Amazon charges for the service.</p>

<h3 id="how-to-set-up-your-dynamodb-tables">How to set up your DynamoDB tables</h3>

<p>The default driver expects a table with a basic HashKey and optional RangeKey both set as strings,
it will then store data serialized in 2 columns named <code class="prettyprint">data</code> and <code class="prettyprint">mediaType</code>.</p>

<p>If you need to explicitly unpack your data in multiple columns, you will need to override serialize
and deserialize like in the following example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">vaults</span><span class="p">.</span><span class="nx">dynamodb</span><span class="p">.</span><span class="nx">serialize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// serialize the primary keys as usual</span>
    <span class="kd">var</span> <span class="nx">item</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createKey</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>

    <span class="c1">// store manually in each column</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">fullName</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'S'</span><span class="p">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">fullName</span> <span class="p">};</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'S'</span><span class="p">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">email</span> <span class="p">};</span>

    <span class="c1">// AWS requires everything to be strings, even numbers, when sent through their API</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">age</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'N'</span><span class="p">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">age</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="p">};</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">interests</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'SS'</span><span class="p">:</span> <span class="nx">value</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">interests</span> <span class="p">};</span>

    <span class="k">return</span> <span class="nx">item</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// make sure to override deserialize too!</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">vaules</span><span class="p">.</span><span class="nx">dynamodb</span><span class="p">.</span><span class="nx">deserialize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// just read data from DynamoDB, you may need to do some type conversions manually</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">fullName</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">fullName</span><span class="p">.</span><span class="nx">S</span><span class="p">,</span>
        <span class="na">email</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">S</span><span class="p">,</span>
        <span class="na">age</span><span class="p">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">age</span><span class="p">.</span><span class="nx">N</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="na">interests</span><span class="p">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">interests</span><span class="p">.</span><span class="nx">SS</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre>
          <h2 id="elasticsearch-vault">Elasticsearch vault</h2>

<p>Elasticsearch is a full-text search engine based on Lucene. It is powered by the <a href="https://github.com/ncb000gt/node-es">elasticsearch</a>
module and supports sharding, either automatic (Elasticsearch will shard everything based on the key) or manual through the
<code class="prettyprint">shard</code> function.</p>

<h3 id="configuration">Configuration</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">elasticsearch</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">elasticsearch</span>
    <span class="na">config</span><span class="pi">:</span>
        <span class="c1"># this is the default index used for storage, you can override this in your code if necessary</span>
        <span class="na">index</span><span class="pi">:</span> <span class="s">testgame</span>
        <span class="c1"># here is your server configuration</span>
        <span class="na">server</span><span class="pi">:</span>
            <span class="na">hostname</span><span class="pi">:</span> <span class="s1">'</span><span class="s">192.168.2.176'</span>
            <span class="na">port</span><span class="pi">:</span> <span class="s">9200</span>
            <span class="na">secure</span><span class="pi">:</span> <span class="s">false</span>
</code></pre>
<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">elasticsearch.get</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">elasticsearch.index</code> with op_type set to <code class="prettyprint">create</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">elasticsearch.index</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">elasticsearch.del</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createTarget(topic, index)</code></td>
<td></td>
<td>use the topic as a type and urlencode the index as the id</td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td>uses live encoding but throws on Buffers</td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>parse live encoding</td>
</tr>
<tr>
<td><code class="prettyprint">shard(value)</code></td>
<td></td>
<td>auto sharding by Elasticsearch</td>
</tr>
</tbody></table>

<h3 id="ttl-support">TTL Support</h3>

<p>Elasticsearch supports automatic expiration of documents, but not updating a documents TTL (you need to repost the whole
document) so the touch function is not available. Also, if using TTL, you will need to manually update your type&rsquo;s mapping
to enable ttl as is explained here: <a href="http://www.elasticsearch.org/guide/reference/mapping/ttl-field/">Ttl Field Reference</a>.</p>

<h3 id="binary-data-storage">Binary data storage</h3>

<p>By default, the serialize function will fail on buffers. It is because Elasticsearch is a full-text document search engine,
as such storing binary data doesn&rsquo;t make much sense. If you really really do need to store binary data, I recommend
either embedding it within an object in base64 format, like:</p>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// retrieve our binary buffer</span>
<span class="kd">var</span> <span class="nx">picture</span> <span class="o">=</span> <span class="nx">uploadedUserPhotoAsBuffer</span><span class="p">();</span>

<span class="c1">// then store it for searching stuff</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'foobar.jpg'</span><span class="p">,</span>
    <span class="na">tags</span><span class="p">:</span> <span class="p">[</span><span class="s1">'cats'</span><span class="p">,</span> <span class="s1">'kawaii'</span><span class="p">],</span>
    <span class="na">data</span><span class="p">:</span> <span class="nx">picture</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">state</span><span class="p">.</span><span class="nx">archivist</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'photos'</span><span class="p">,</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">userId</span><span class="p">,</span> <span class="na">pictureId</span><span class="p">:</span> <span class="nx">pictureId</span> <span class="p">},</span> <span class="nx">data</span><span class="p">);</span>
</code></pre>
<p>Then manually decode it when getting it back from Elasticsearch.</p>

<p>Another (more recommended) way to do that is to use Elasticsearch to only store the metadata for search purposes and
store the binary file itself in a more appropriate vault (such as file).</p>

<h3 id="searching-for-data">Searching for data</h3>

<p>Archivist doesn&rsquo;t provide any way to search for data in a complex manner, if you need to search for data you will need
to call the Elasticsearch client yourself, here is an example of how to find the picture stored in the example above:</p>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// retrieve client</span>
<span class="kd">var</span> <span class="nx">esClient</span> <span class="o">=</span> <span class="nx">archivist</span><span class="p">.</span><span class="nx">getReadVault</span><span class="p">(</span><span class="s1">'elasticsearch'</span><span class="p">).</span><span class="nx">client</span><span class="p">;</span>

<span class="c1">// the index is automatically filled in from the configuration but if need you can just override _index here</span>
<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="na">_type</span><span class="p">:</span> <span class="s1">'photos'</span> <span class="p">};</span>

<span class="c1">// build query, for example every photos tagged with cats</span>
<span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">term</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">tags</span><span class="p">:</span> <span class="s1">'cats'</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// then run your search query</span>
<span class="nx">esClient</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// then parse the data array</span>
<span class="p">});</span>
</code></pre>
<p>For more details about the Elasticsearch client, please read this <a href="https://github.com/ncb000gt/node-es">documentation</a>,
then for the Elasticsearch query language please read the <a href="http://www.elasticsearch.org/guide/reference/api/search/query/">Query</a>
and <a href="http://www.elasticsearch.org/guide/reference/query-dsl/">Query DSL</a> documentation on the Elasticsearch website.</p>

<h3 id="notes-about-manual-sharding">Notes about manual sharding</h3>

<p>While it is possible to override the sharding by making the <code class="prettyprint">api.shard</code> return a string, special attention is to be made
so that sharding always yield the same result for records, elasticsearch will not throw any error if the same id with
different data exists in 2 different shards and both values will be retrieved by the search function.</p>

          <h2 id="manta-vault">Manta vault</h2>

<p>The node-manta module is supported through the built-in &ldquo;manta&rdquo; vault type.</p>

<h3 id="about-joyent-manta">About Joyent Manta</h3>

<p>From <a href="http://apidocs.joyent.com/manta/index.html#sign-up">Joyent Manta documentation</a>:</p>

<p>To use Joyent Manta Storage Service, you need a Joyent Cloud account. If you don&rsquo;t already have an
account, you can create one at https://my.joyentcloud.com/signup. You will not be charged for Joyent
Manta Storage Service until you use it.</p>

<p>Once you have signed up, you will need to add an SSH public key to your account. Joyent recommends
using RSA keys, as the <code class="prettyprint">node-manta</code> CLI programs will work with RSA keys both locally, and with the
<code class="prettyprint">ssh agent</code>. DSA keys will only work if the private key is on the same system as the CLI, and not
password-protected.</p>

<h3 id="configuration">Configuration</h3>

<p>Assuming you have set up a public key with Joyent, you can configure the Manta Vault as follows:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">type</span><span class="pi">:</span> <span class="s">manta</span>
<span class="na">config</span><span class="pi">:</span>
    <span class="c1"># url is optional</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://us-east.manta.joyent.com"</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">bob</span>
    <span class="na">sign</span><span class="pi">:</span>
        <span class="na">keyId</span><span class="pi">:</span> <span class="s2">"</span><span class="s">a3:81:a2:2c:8f:c0:18:43:8a:1e:cd:12:40:fa:65:2a"</span>

        <span class="c1"># key may be replaced with "keyPath" (path to a private key file), or omitted to fallback to</span>
        <span class="c1"># "~/.ssh/id_rsa"</span>
        <span class="na">key</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="no">-----BEGIN RSA PRIVATE KEY-----</span>
          <span class="no">..etc..</span>
          <span class="no">-----END RSA PRIVATE KEY-----</span>
</code></pre>
<p>Where <code class="prettyprint">keyId</code> is the fingerprint of your public key, which can be retrieved by running:</p>
<pre class="highlight shell tab-shell"><code>ssh-keygen -l -f <span class="nv">$HOME</span>/.ssh/id_rsa.pub | awk <span class="s1">'{print $2}'</span>
</code></pre>
<p>And where <code class="prettyprint">key</code> is your private key. As an alternative to the <code class="prettyprint">key</code> field, you may provide a
<code class="prettyprint">keyPath</code> field which points to the file containing your private key.</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">manta.ls()</code></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">manta.get()</code></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">manta.put()</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">manta.unlink()</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th>required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createFolder(topic)</code></td>
<td></td>
<td>urlencode(topic)</td>
</tr>
<tr>
<td><code class="prettyprint">createFileName(index)</code></td>
<td></td>
<td>URL encoded query string or &ldquo;void&rdquo;, followed by .bin file extension</td>
</tr>
<tr>
<td><code class="prettyprint">parseFileName(fileName)</code></td>
<td></td>
<td>Parses query string back into index</td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td></td>
<td><code class="prettyprint">{ data: Buffer, mediaType: value.mediaType }</code></td>
</tr>
<tr>
<td><code class="prettyprint">deserialize(data, value)</code></td>
<td></td>
<td>From serialized to VaultValue with mediaType</td>
</tr>
</tbody></table>

          <h2 id="client-vault">Client vault</h2>

<p>This vault is used to send updates to the player, so that their data is always synchronized in real
time. This vault is always created when an archivist is instantiated by a <code class="prettyprint">State</code> object, using a
name identical to the type: <code class="prettyprint">client</code>.</p>

<h3 id="configuration">Configuration</h3>

<p>This vault type requires no configuration.</p>

<h3 id="supported-operations">Supported operations</h3>

<table><thead>
<tr>
<th>operation</th>
<th style="text-align: center">supported</th>
<th>implementation</th>
</tr>
</thead><tbody>
<tr>
<td>list</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>get</td>
<td style="text-align: center"></td>
<td></td>
</tr>
<tr>
<td>add</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">state.emitToActors(&#39;archivist:set&#39;)</code></td>
</tr>
<tr>
<td>set</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">state.emitToActors(&#39;archivist:set&#39; or &#39;archivist:applyDiff&#39;)</code></td>
</tr>
<tr>
<td>touch</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">state.emitToActors(&#39;archivist:touch&#39;)</code></td>
</tr>
<tr>
<td>del</td>
<td style="text-align: center">âœ”</td>
<td><code class="prettyprint">state.emitToActors(&#39;archivist:del&#39;)</code></td>
</tr>
</tbody></table>

<h3 id="required-topic-api">Required Topic API</h3>

<table><thead>
<tr>
<th>signature</th>
<th style="text-align: center">required</th>
<th>default implementation</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">createKey(topic, index)</code></td>
<td style="text-align: center"></td>
<td><code class="prettyprint">{ topic: topic, index: index }</code></td>
</tr>
<tr>
<td><code class="prettyprint">serialize(value)</code></td>
<td style="text-align: center"></td>
<td><code class="prettyprint">{ mediaType: &#39;&#39;, data: &#39;&#39;, encoding: &#39;utf8/base64&#39; }</code></td>
</tr>
<tr>
<td><code class="prettyprint">shard(value)</code></td>
<td style="text-align: center">âœ”</td>
<td></td>
</tr>
</tbody></table>

          <h1 id="service-discovery">Service Discovery</h1>

<p>The Service Discovery library is a library that allows you to announce and discover services on the local network,
through different types of engines. It helps coordinating larges clusters of applications by providing a near zero
configuration environment.</p>

<p>The service allows the user to provides metadata that is stored on the network and retrieved when discovering devices,
code can then do filtering or retrieve basic configuration options from this metadata.</p>

<p><strong>Warning!</strong> Metadata should never contain any sensitive data such as usernames, passwords, etc&hellip;! In the case of mDNS
for example, data is broadcasted using UDP on the local network with no restriction, as such any device on the local
network can access this metadata!</p>

<h2 id="configuration">Configuration</h2>

<p>To use service discovery, configuration is mandatory. Due to the nature of cloud based solutions such as Amazon EC2,
mDNS will fail to work correctly and you will need to setup an alternative. For now the only alternative is zookeeper.</p>

<p>The <code class="prettyprint">mDNS</code> configuration is as follows:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">serviceDiscovery</span><span class="pi">:</span>
        <span class="na">engine</span><span class="pi">:</span> <span class="s">mdns</span>
        <span class="na">options</span><span class="pi">:</span>
            <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">UniqueIdOnTheNetwork"</span> <span class="c1"># optional</span>
</code></pre>
<p>The <code class="prettyprint">zookeeper</code> configuration is as follows:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">serviceDiscovery</span><span class="pi">:</span>
        <span class="na">engine</span><span class="pi">:</span> <span class="s">zookeeper</span>
        <span class="na">options</span><span class="pi">:</span>
            <span class="na">hosts</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.1.12:2181,192.168.3.18:2181,etc..."</span>
</code></pre>
<p>The <code class="prettyprint">single</code> configuration is as follows:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">serviceDiscovery</span><span class="pi">:</span>
        <span class="na">engine</span><span class="pi">:</span> <span class="s">single</span>
</code></pre>
<h2 id="api">API</h2>

<h3 id="module">Module</h3>

<h4 id="methods">Methods</h4>

<ul>
<li><code class="prettyprint">serviceDiscovery.createService(name, type)</code>, where <code class="prettyprint">name</code> is the name of your service, and <code class="prettyprint">type</code> is either <em>tcp</em>
or <em>udp</em>. Returns a <code class="prettyprint">Service</code> instance.</li>
</ul>

<h3 id="service">Service</h3>

<h4 id="methods">Methods</h4>

<ul>
<li><code class="prettyprint">service.announce(port, metadata, cb)</code>, where <code class="prettyprint">port</code> is the port you want to announce, <code class="prettyprint">metadata</code> is a blob of data associated
with the service and <code class="prettyprint">cb</code> is a callback called with a potential error object once the announcement is done.</li>
<li><code class="prettyprint">service.discover()</code>, starts the discovery process, firing events when nodes gets up or down on the network</li>
</ul>

<h4 id="events">Events</h4>

<ul>
<li><code class="prettyprint">up</code>, fired when a node appear on the network (after an announcement), provides a <code class="prettyprint">ServiceNode</code> instance.</li>
<li><code class="prettyprint">down</code>, fired when a node disappear from the network, also provides a <code class="prettyprint">ServiceNode</code> instance.</li>
<li><code class="prettyprint">error</code>, fired when an error occur.</li>
</ul>

<h3 id="servicenode">ServiceNode</h3>

<h4 id="properties">Properties</h4>

<ul>
<li><code class="prettyprint">host</code>, the hostname of the machine hosting the service.</li>
<li><code class="prettyprint">port</code>, the announced port.</li>
<li><code class="prettyprint">addresses</code>, a list of ips, either IPv4 or IPv6, see the method <code class="prettyprint">getIp</code> for a better way to access this list.</li>
<li><code class="prettyprint">data</code>, the metadata associated with the service.</li>
</ul>

<h4 id="methods">Methods</h4>

<ul>
<li><code class="prettyprint">getIp(version, network)</code>, allows you to retrieve an IP from the addresses list, <code class="prettyprint">version</code> is the IP version, either 4 or 6.
<code class="prettyprint">network</code> is an array containing the network list where your service is.
The <a href="http://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation">CIDR notation</a> is used to represent the networks.</li>
<li><code class="prettyprint">isLocal()</code>, whether the node is running on the current server or not.</li>
</ul>

<h4 id="todo">Todo</h4>

<ul>
<li>Add a method to iterate on ips by version</li>
<li>Add a up/down event on the node itself?</li>
</ul>

<h2 id="examples">Examples</h2>

<h3 id="finding-nodes-on-the-network">Finding nodes on the network</h3>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// load the module</span>
<span class="kd">var</span> <span class="nx">serviceDiscovery</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../serviceDiscovery'</span><span class="p">),</span>
    <span class="nx">mage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../mage'</span><span class="p">),</span>
    <span class="nx">logger</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">context</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">),</span>
    <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'some-imaginary-mysql-client-module'</span><span class="p">);</span>

<span class="c1">// create our service, let's say for mysql servers on a tcp socket</span>
<span class="kd">var</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">serviceDiscovery</span><span class="p">.</span><span class="nx">createService</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">,</span> <span class="s1">'tcp'</span><span class="p">);</span>

<span class="c1">// when a mysql server appear on the network</span>
<span class="nx">service</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'up'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// connect to the mysql service we just found</span>
    <span class="nx">mysql</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">service</span><span class="p">.</span><span class="nx">getIp</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="nx">service</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// fatal</span>
        <span class="p">}</span>

        <span class="c1">// do stuff</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// or when one goes down</span>
<span class="nx">service</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'down'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// mysql went down, start panicking!</span>
<span class="p">});</span>

<span class="c1">// start discovering</span>
<span class="nx">service</span><span class="p">.</span><span class="nx">discover</span><span class="p">();</span>
</code></pre>
<h3 id="announcing-your-service-to-the-world">Announcing your service to the world</h3>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// load the module</span>
<span class="kd">var</span> <span class="nx">serviceDiscovery</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../serviceDiscovery'</span><span class="p">),</span>
    <span class="nx">mage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../mage'</span><span class="p">),</span>
    <span class="nx">logger</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">context</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">),</span>
    <span class="nx">hello</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'imaginary-hello-server'</span><span class="p">);</span>

<span class="c1">// create our service, let's say this is a hello world HTTP server</span>
<span class="kd">var</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">serviceDiscovery</span><span class="p">.</span><span class="nx">createService</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="s1">'tcp'</span><span class="p">);</span>

<span class="nx">hello</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// error stuff</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">emergency</span><span class="p">(</span><span class="s1">'Could not start hello server on port 80'</span><span class="p">);</span>
        <span class="nx">mage</span><span class="p">.</span><span class="nx">fatalError</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// announce our service to everyone, and also tell them that we support SPDY</span>
    <span class="nx">service</span><span class="p">.</span><span class="nx">announce</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="p">{</span> <span class="na">spdySupport</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// error stuff</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">emergency</span><span class="p">(</span><span class="s1">'No one can see us, announcing failed!'</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">'Server announced successfully!'</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre>
          <h2 id="single-server-discovery-engine">Single-server discovery engine</h2>

<p>This engine allows you to have a fake service discovery engine, to have the
service discovery library available when you are using only one server.</p>

<p>The services are stored directly in memory.
In cluster mode, it uses the <a href="../../../processMessenger">process messenger</a>
to exchange messages between master and workers.</p>

<h3 id="limitations">Limitations</h3>

<ul>
<li>It works only if you have no more than one server.</li>
</ul>

          <h2 id="mdns-discovery-engine">mDNS discovery engine</h2>

<p>mDNS is a discovery protocol designed by Apple in 2002. It uses UDP multicasting to send on the network service
announcements which can be used by other devices/services to connect or access servers without the need for any
configuration, it was initially developed for printers and similar devices.</p>

<h3 id="limitations">Limitations</h3>

<p>Due to the nature of UDP broadcasts/multicasts, they can only be transfered on Level 2 LAN networks. That mean that
any higher kind of network won&rsquo;t be able to see/transmit those packets, and the discovery will fail. Amazon EC2 is an
example of network that will not work with mDNS even when using Amazon VPC.</p>

<h3 id="configuration">Configuration</h3>

<p>In the <code class="prettyprint">server.serviceDiscovery.options</code> object the following options exists:
 - <strong>description</strong>: A string that allows you to override the service name generated by the engine. It needs to be
   unique on the network!</p>

<h3 id="debugging">Debugging</h3>

<p>When announcing with mDNS, there are several tools that allows seeing the network topography in great details, metadata
included:</p>

<ul>
<li><strong>Linux</strong>: <code class="prettyprint">avahi-discover</code> will discover the whole network, clicking on services will display the metadata at the
bottom of the screen.</li>
<li><strong>macOS</strong>: <a href="http://www.tildesoft.com/">BonjourBrowser</a> will do that for you.</li>
<li><strong>Windows</strong>: <code class="prettyprint">Bonjour Browser for Windows</code> should do that for you.</li>
</ul>

          <h2 id="zookeeper-discovery-engine">ZooKeeper discovery engine</h2>

<p>Apache ZooKeeper is a project from the Apache Software Foundation that provides distributed
datastores for large distributed systems. It is part of the Hadoop eco-system. It uses a
hierarchical tree for storing data similar to a file-system.</p>

<h3 id="configuration">Configuration</h3>

<p>In the <code class="prettyprint">server.serviceDiscovery.options</code> object the following options exists:</p>

<ul>
<li><strong>hosts</strong>: A string that contains a list of host:port separated with commas.</li>
<li><strong>options</strong>: The <code class="prettyprint">options</code> object accepted by <a href="https://github.com/alexguan/node-zookeeper-client#client-createclientconnectionstring-options">createClient</a>.</li>
</ul>

<p>The <code class="prettyprint">node-zookeeper-client</code> library applies 0 retries as a default, which we override with <code class="prettyprint">3</code>.
You can tweak these settings further by configuring the <code class="prettyprint">options</code> above.</p>

<h3 id="limitations">Limitations</h3>

<p>ZooKeeper is written in Java so is very heavy, moreover watchers and other niceties are far too
lightweight and causes a lot more work than should be necessary when events happen (like having to
manually build the difference when nodes change).</p>

<h3 id="debugging">Debugging</h3>

<p>When debugging, it is possible to retrieve the zookeeper install file and connects using the
<code class="prettyprint">bin/zkCli.sh</code> file provided in the SDK using the following command:</p>

<p><code class="prettyprint">bin/zkCli.sh -server &lt;serverip&gt;:&lt;port&gt;</code></p>

<p>The CLI will then connect and display a list of commands available, the important ones are:</p>

<ul>
<li><code class="prettyprint">ls &lt;path&gt;</code>, show the children list for that path.</li>
<li><code class="prettyprint">get &lt;path&gt;</code>, retrieve the metadata and details for a particular node.</li>
</ul>

          <h1 id="http-server">HTTP Server</h1>

<h2 id="registering-routes">Registering routes</h2>

<h3 id="httpserver-addroute-pathmatch-handlerfunction-type">httpServer.addRoute(pathMatch, handlerFunction, type)</h3>

<p>This registers a route (a string or a regular expression) on the HTTP server. Incoming requests will
be expected to be handled by the handler function you pass. Based on the type you specify, your
handler function will receive different arguments.</p>

<h4 id="simple-handler-req-res-path-query-urlinfo">&ldquo;simple&rdquo;: handler(req, res, path, query, urlInfo)</h4>

<ul>
<li>req: the IncomingMessage object.</li>
<li>res: the ServerResponse object.</li>
<li>path: the path part of the URL.</li>
<li>query: the parsed query string.</li>
<li>urlInfo: all information that came out of <code class="prettyprint">url.parse()</code>.</li>
</ul>

<h4 id="callback-handler-req-path-query-callback">&ldquo;callback&rdquo;: handler(req, path, query, callback)</h4>

<ul>
<li>req: the IncomingMessage object.</li>
<li>path: the path part of the URL.</li>
<li>query: the parsed query string.</li>
<li>callback: call this when you&rsquo;ve constructed your HTTP response.</li>
</ul>

<p>The callback accepts the following arguments in order:</p>

<ul>
<li>httpCode: the HTTP status code you want to return.</li>
<li>out: a string or buffer that you want to send to the client.</li>
<li>headers: an object with headers.</li>
</ul>

<h4 id="websocket-handler-client-urlinfo">&ldquo;websocket&rdquo;: handler(client, urlInfo)</h4>

<ul>
<li>client: a WebSocket client connection object. See the <a href="https://npmjs.org/package/ws"><code class="prettyprint">ws</code> documentation</a>.</li>
<li>urlInfo: all information that came out of <code class="prettyprint">url.parse()</code>.</li>
</ul>

<h4 id="proxy-endpoint-handler-req-urlinfo">&ldquo;proxy&rdquo;: endpoint handler(req, urlInfo)</h4>

<ul>
<li>req: the IncomingMessage object.</li>
<li>urlInfo: all information that came out of <code class="prettyprint">url.parse()</code>.</li>
</ul>

<p>Your handler function <em>must</em> return an endpoint object to connect to. For syntax, please read the
<a href="http://nodejs.org/docs/latest/api/net.html#net_net_connect_options_connectionlistener"><code class="prettyprint">net.connect()</code></a>
documentation.</p>

<h3 id="httpserver-delroute-pathmatch">httpServer.delRoute(pathMatch)</h3>

<p>Removes the handler function registered on the given route.</p>

<h2 id="simple-file-serving">Simple file serving</h2>

<h3 id="httpserver-servefolder-route-folderpath-defaultfile-onfinish">httpServer.serveFolder(route, folderPath, [defaultFile], [onFinish])</h3>

<p>Registers a route to lead directly to a folder on disk. If you want to be notified when a request finishes, you may pass
an <code class="prettyprint">onFinish</code> function. It may receive an error as its first argument. If you decide to pass this function, logging the
error will be your responsibility.</p>

<p>Example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">httpServer</span><span class="p">.</span><span class="nx">serveFolder</span><span class="p">(</span><span class="s1">'/source'</span><span class="p">,</span> <span class="s1">'./lib'</span><span class="p">);</span>
</code></pre>
<p>If you provide a <code class="prettyprint">defaultFile</code> file name argument, serving up a folder by its name will serve up a default file if it
exists.</p>

<p>Example:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">httpServer</span><span class="p">.</span><span class="nx">serveFolder</span><span class="p">(</span><span class="s1">'/source'</span><span class="p">,</span> <span class="s1">'./lib'</span><span class="p">,</span> <span class="s1">'index.html'</span><span class="p">);</span>
</code></pre>
<h3 id="httpserver-servefile-route-filepath-onfinish">httpServer.serveFile(route, filePath, [onFinish])</h3>

<p>Registers a route to lead directly to a file on disk. If you want to be notified when a request finishes, you may pass
an <code class="prettyprint">onFinish</code> function. It may receive an error as its first argument. If you decide to pass this function, logging the
error will be your responsibility.</p>

<h2 id="check-txt">check.txt</h2>

<p>By default, the HTTP server will serve a file &ldquo;check.txt&rdquo; from the root folder of your project, if
it exists. This can be useful for services such as load-balancers to poll for the availability of
your application.</p>

<h2 id="custom-favicon">Custom Favicon</h2>

<h3 id="httpserver-setfavicon-buffer-mimetype">httpServer.setFavicon(buffer, [mimetype])</h3>

<p>Registers a route &ldquo;/favicon.ico&rdquo; and serves the given buffer as content. The mime type defaults to
<code class="prettyprint">image/x-icon</code> and may be overridden.</p>

<h2 id="cross-origin-resource-sharing-cors">Cross-Origin Resource Sharing (CORS)</h2>

<p>If you want your application to span multiple domains, you need to enable CORS. For information on
what CORS is, please consult the following websites.</p>

<ul>
<li><a href="http://www.html5rocks.com/en/tutorials/cors/">HTML5 Rocks tutorial</a></li>
<li><a href="https://developer.mozilla.org/en/docs/HTTP/Access_control_CORS">Mozilla</a></li>
<li><a href="http://www.w3.org/TR/cors/">w3c spec</a></li>
</ul>

<h3 id="performance">Performance</h3>

<p>Keep in mind that using CORS will often cause so-called &ldquo;preflight&rdquo; requests. A preflight request
is an HTTP <code class="prettyprint">OPTIONS</code> request to the server to confirm if a request is allowed to be made in a manner
that is considered safe for the user. Only after this confirmation will a real <code class="prettyprint">GET</code> or <code class="prettyprint">POST</code>
request be made. All this happens invisible to the end user and developer, but there is a
performance penalty that you pay, caused by this extra round trip to the server.</p>

<h3 id="using-authentication-and-cors">Using authentication and CORS</h3>

<p>If you use <code class="prettyprint">Basic</code> or any other HTTP authentication mechanism, you cannot configure CORS to allow
any origin using the <code class="prettyprint">*</code> wildcard symbol. In that case, you must specify exactly which origin is
allowed to access your server.</p>

<h3 id="configuration">Configuration</h3>

<p>In your configuration, you can enable CORS like this:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">clientHost</span><span class="pi">:</span>
        <span class="na">cors</span><span class="pi">:</span>
            <span class="na">methods</span><span class="pi">:</span> <span class="s2">"</span><span class="s">GET,</span><span class="nv"> </span><span class="s">POST,</span><span class="nv"> </span><span class="s">OPTIONS"</span>
            <span class="na">origin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://mage-app.wizcorp.jp"</span>
            <span class="na">credentials</span><span class="pi">:</span> <span class="s">true</span>
</code></pre>
<ul>
<li><code class="prettyprint">methods</code> (optional) lists which HTTP request methods are acceptable.</li>
<li><code class="prettyprint">origin</code> (optional) sets the required origin, may be (and defaults to) <code class="prettyprint">&quot;*&quot;</code></li>
<li><code class="prettyprint">credentials</code> (optional) must be set to <code class="prettyprint">true</code> if you want cookies and HTTP authentication to be
usable at all. You can then no longer use the wildcard origin.</li>
</ul>

<h3 id="cors-in-ie9">CORS in IE9</h3>

<p>The XMLHttpRequest object exist on IE8+ but sadly <a href="http://caniuse.com/#search=cors">CORS is not supported on IE8 and IE9</a>.
So the idea is to use the XDomainRequest object for those old version of IE but here is the catch:
XDomainRequest doesn&rsquo;t hold a status code.</p>

<h4 id="how-to-deal-with-ie9-without-status-code-then">How to deal with IE9 without status code then?</h4>

<p>You may already have it in place in your app. If not, here what you could do.</p>

<p>When communicating with the server, the request will time out and generate a &lsquo;network&rsquo; error.
You can listen to it from the msgServer <code class="prettyprint">msgServer.on(&#39;io.error.network&#39;, doSomething);</code>.
The suggestion here is to retry (<code class="prettyprint">msgServer.resend();</code>) on a network error and to reload the app
after n retries. If the app is in maintenance it would probably show the maintenance page.</p>

<h5 id="what-does-it-change-for-other-browsers">What does it change for other browsers?</h5>

<p>Absolutely nothing. And you can still apply the retry logic on network errors, it&rsquo;s not a bad idea.</p>

<h3 id="log-configuration">Log Configuration</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">quietRoutes</span><span class="pi">:</span> <span class="c1"># Filter out debug and verbose logs for URLs matching these regex</span>
        <span class="pi">-</span> <span class="s">^\/check\.txt</span>
        <span class="pi">-</span> <span class="s">^\/favicon\.ico</span>
    <span class="na">longRoutes</span><span class="pi">:</span> <span class="c1"># Filter out long warnings for URLs matching these regex</span>
        <span class="pi">-</span> <span class="s">^\/msgstream</span>
    <span class="na">longThreshold</span><span class="pi">:</span> <span class="s">500</span> <span class="c1"># The number of milliseconds before a request is considered to be taking too long</span>
</code></pre>
<p>The following logs will be filtered out when the url for the request matches any regex in the
<code class="prettyprint">quietRoutes</code>:</p>
<pre class="highlight plaintext tab-plaintext"><code>m-28019 - 19:58:44.830     &lt;debug&gt; [MAGE http] Received HTTP GET request: /check.txt
m-28019 - 19:58:44.830   &lt;verbose&gt; [MAGE http] Following HTTP route /check.txt
</code></pre>
<p>The following log will be shown for any http request that takes longer than the configured
<code class="prettyprint">longThreshold</code> and can be filtered out when the url for the request matches any reges in the
<code class="prettyprint">longRoutes</code>:</p>
<pre class="highlight plaintext tab-plaintext"><code>m-876 - 20:08:58.193   &lt;warning&gt; [MAGE http] /app/pc/landing completed in 1181 msec
</code></pre>
          <h1 id="message-server">Message Server</h1>

<p>The message server is in charge of message propagation through the network and between the clients and the backend.</p>

<h2 id="cluster-identification">Cluster Identification</h2>

<p>Currently the message server system will identify itself as being a part of a cluster by using the application root
package name and version. However in environment where multiple instances of the same application and version are run,
there will be conflicts with the messaging system. (e.g. inside single box which houses multiple test environments).</p>

<p>To prevent pollution and contamination of messages, the <code class="prettyprint">server.serviceName</code> configuration entry needs to be set, to
give each environment a unique identifier.</p>

<p>Example:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">serviceName</span><span class="pi">:</span> <span class="s">applicationName-environmentID</span>
</code></pre>
<h2 id="subsystems">Subsystems</h2>

<p>The systems that make the message server and their configuration are described below.</p>

<h3 id="mmrp">MMRP</h3>

<p>The message server uses the MMRP library to ensure communication between the different MAGE instances on the network.
In order to find these instances, you need to have <a href="#service-discovery">service discovery</a> set up.</p>

<p>To use MMRP, please configure it to bind to a particular port and pick a network on which it is expected to communicate.</p>

<p>Example:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">mmrp</span><span class="pi">:</span>
        <span class="na">bind</span><span class="pi">:</span>
            <span class="na">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>  <span class="c1"># asterisk for 0.0.0.0, or a valid IP address</span>
            <span class="na">port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">*"</span>  <span class="c1"># asterisk for any port, or a valid integer</span>
        <span class="na">network</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">192.168.2"</span>  <span class="c1"># formatted according to https://www.npmjs.com/package/netmask</span>
</code></pre>
<p>For more information, please read the <a href="#mmrp">MMRP documentation</a>.</p>

<h3 id="message-stream">Message stream</h3>

<p>The messages sent by the server inevitably make their way to a client through a message stream.</p>

<p>For more information, please read the <a href="#message-stream">Message stream documentation</a>.</p>

<h2 id="sending-messages">Sending messages</h2>

<p>It is recommended to use the <a href="../state/Readme.md">State class</a> to send and broadcast messages to users, but if you want
more control over or a better understanding about how messages are sent, please keep on reading.</p>

<p>Keep in mind that the system makes no guarantees that the message will actually be delivered, although as long as the
address and clusterId you pass are valid, and that user remains logged in, the message should be received.</p>

<h3 id="sending-a-single-message">Sending a single message</h3>

<p>You can send a message directly to a user using the following call.</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">msgServer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">clusterId</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</code></pre>
<p>Where:</p>

<ul>
<li><code class="prettyprint">address</code> is the recipient&rsquo;s session key.</li>
<li><code class="prettyprint">clusterId</code> refers to the physical location in the network where that session&rsquo;s messages are being stored for delivery.</li>
<li><code class="prettyprint">message</code> is a string or Buffer containing valid JSON, or an array of strings/Buffers if you want to send a batch.</li>
</ul>

<h3 id="broadcasting-a-message-to-all-logged-in-users">Broadcasting a message to all logged-in users</h3>

<p>You can send a message to all logged-in users, by using the following call.</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">msgServer</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</code></pre>
<p>Where:</p>

<ul>
<li><code class="prettyprint">message</code> is a string or Buffer, or when you want to send multiple messages, an array of strings/Buffers.</li>
</ul>

<h2 id="receiving-messages-on-a-web-client">Receiving messages on a web client</h2>

<p>The MAGE client will receive messages and emit them as events. You can listen for them through <code class="prettyprint">mage.eventManager</code>.</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">eventManager</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'event.name'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* use the message */</span>
<span class="p">});</span>
</code></pre>
<p>For now, the only way to receive these messages is to make sure messages are sent or broadcast with the following format:</p>
<pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
  </span><span class="p">[</span><span class="s2">"event.name"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">"key"</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">"another"</span><span class="p">:</span><span class="s2">"value"</span><span class="p">}],</span><span class="w">
  </span><span class="p">[</span><span class="s2">"another.event"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s2">"etc"</span><span class="p">:</span><span class="kc">false</span><span class="p">}],</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h2 id="testing-your-application-with-aeriscloud-and-marathon">Testing your application with AerisCloud and Marathon</h2>

<p>When using AerisCloud to test your application across a cluster of servers using the Marathon service, please make sure
to include the following configuration in <code class="prettyprint">config/marathon.yaml</code>. Over time, the addresses below may change, so always
stay in touch with your friendly local system administrator to make sure these make sense.</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">server</span><span class="pi">:</span>
    <span class="na">clientHost</span><span class="pi">:</span>
        <span class="na">expose</span><span class="pi">:</span> <span class="s">null</span>
        <span class="na">bind</span><span class="pi">:</span>
            <span class="na">port</span><span class="pi">:</span> <span class="s">PORT0</span>
    <span class="na">serviceDiscovery</span><span class="pi">:</span>
        <span class="na">engine</span><span class="pi">:</span> <span class="s2">"</span><span class="s">zookeeper"</span>
        <span class="na">options</span><span class="pi">:</span>
            <span class="na">hosts</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.2.21:2181"</span>
    <span class="na">mmrp</span><span class="pi">:</span>
        <span class="na">bind</span><span class="pi">:</span>
            <span class="na">port</span><span class="pi">:</span> <span class="s">PORT1</span>
        <span class="na">network</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">192.168.2"</span>
</code></pre>
<p>Your Makefile needs to replace the magical constants PORT0 and PORT1 in this file when running. Here&rsquo;s an example of
the marathon Make target:</p>
<pre class="highlight make tab-make"><code><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">marathon</span>

<span class="nl">marathon</span><span class="o">:</span>
    <span class="err">source</span> <span class="err">/opt/nvm/nvm.sh</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
    <span class="err">sed</span> <span class="err">-i</span> <span class="s2">"s/PORT0/${PORT0}/"</span> <span class="err">config/marathon.yaml</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
    <span class="err">sed</span> <span class="err">-i</span> <span class="s2">"s/PORT1/${PORT1}/"</span> <span class="err">config/marathon.yaml</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
    <span class="err">sed</span> <span class="err">-i</span> <span class="s2">"s/PORT/${PORT}/"</span> <span class="err">config/marathon.yaml</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
    <span class="err">nvm</span> <span class="err">use</span> <span class="err">0.10.33</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
    <span class="nv">NODE_ENV</span><span class="o">=</span>production,marathon <span class="nv">HOME</span><span class="o">=</span><span class="k">${</span><span class="nv">MESOS_DIRECTORY</span><span class="k">}</span> make deps <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nv">NODE_ENV</span><span class="o">=</span>production,marathon node .
</code></pre>
<p>When pushing the application to Marathon, you need to select ports for PORT0 and PORT1. An example:</p>
<pre class="highlight shell tab-shell"><code>aeriscloud marathon office/jp push -p 80 16001
</code></pre>
<p>For more information about using Marathon, please read the <a href="https://github.com/Wizcorp/AerisCloud/blob/master/docs/walkthrough/marathon.md">documentation</a></p>

          <h1 id="mmrp">MMRP</h1>

<h2 id="general-concept">General concept</h2>

<p>MMRP (MAGE Message Relay Protocol) is the messaging layer between node instances. It is used to
enable communication between multiple MAGE instances and between the different node processes run by
MAGE. In the end, it allows messages to flow from one user to another.</p>

<p>Imagine a network set up like the following, where 3 servers each host a
<a href="http://nodejs.org/docs/latest/api/cluster.html">process-cluster</a>.</p>
<pre class="highlight plaintext tab-plaintext"><code> Cluster 1                Cluster 2                Cluster 3
  +-----+                  +-----+                  +-----+
  |     |                  |     |                  |     |
  |  M  +------------------+  M  +------------------+ M/W |
  |     |                  |     |                  |     |
  +--+--+                  ++---++                  +-----+
     |                      |   |
     |                   +--+   +--+
     |                   |         |
  +--+--+             +--+--+   +--+--+
  |     |             |     |   |     |
  |  W  |             |  W  |   |  W  |
  |     |             |     |   |     |
  +-----+             +-----+   +-----+


M: MAGE master / MMRP relay
W: MAGE worker / MMRP client
</code></pre>
<p>Each MAGE master will instantiate an MMRP relay, and each worker an MMRP client. If MAGE is running
in single-node mode (that is, the cluster consists of only a single process), it will instantiate
MMRP as both a relay and as a client. Through this topology, messages can be sent between all
processes (or nodes) in the MAGE network.</p>

<p>MMRP depends on <a href="../../serviceDiscovery/Readme.md">service discovery</a> to announce relays on the
network to each process. The protocol and library used to communicate between processes is
<a href="http://zeromq.org/">ZeroMQ</a>.</p>

<h2 id="mmrp-nodes">MMRP Nodes</h2>

<h3 id="node-api">Node API</h3>

<h4 id="construction">Construction</h4>

<p>To get started, you must have access to an MMRP node object, or create one like this:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">MmrpNode</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">msgServer</span><span class="p">.</span><span class="nx">mmrp</span><span class="p">.</span><span class="nx">MmrpNode</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">role</span> <span class="o">=</span> <span class="s1">'relay'</span><span class="p">;</span> <span class="c1">// or 'client', or 'both'</span>
<span class="kd">var</span> <span class="nx">cfg</span> <span class="o">=</span> <span class="p">{</span> <span class="na">host</span><span class="p">:</span> <span class="s1">'*'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="s1">'*'</span> <span class="p">};</span>
<span class="kd">var</span> <span class="nx">clusterId</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'os'</span><span class="p">).</span><span class="nx">hostname</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MmrpNode</span><span class="p">(</span><span class="nx">role</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nx">clusterId</span><span class="p">);</span>
</code></pre>
<h4 id="node-relayup-uri-clusterid">node.relayUp(uri, clusterId)</h4>

<p>Notify the node that another relay has become available at a particular URI with a particular
clusterId. If the node is a relay, it should connect to it. If the node is a client, it should
connect to it only if it&rsquo;s the relay of the same clusterId as the client.</p>

<h4 id="node-relaydown-uri">node.relayDown(uri)</h4>

<p>Notify the node that another relay has become unavailable. If we are connected to it, we should use
this as an advice to disconnect.</p>

<h4 id="node-send-envelope-attempts">node.send(envelope, attempts)</h4>

<p>Sends an envelope across the network according to the route inside it. If attempts is passed, the
node will try to resend the envelope if routing failed. Retrying should normally not be needed, as
ZeroMQ manages connections and buffers for you.</p>

<h4 id="node-broadcast-envelope">node.broadcast(envelope)</h4>

<p>Will broadcast the envelope to every node on the network.</p>

<h3 id="node-events">Node events</h3>

<h4 id="delivery">delivery</h4>

<p>When an envelope is received, a delivery is always fired, <em>even</em> if the envelope is not intended for
this cluster or even this node in the cluster! It is up to the receiver to decide to act on it or
not. You can listen for the event based on the type of the envelope that is being delivered.</p>

<p>For example, if the type of the envelope is <code class="prettyprint">&quot;my.special.namespace&quot;</code>, a total of four events will
be emitted with the envelope as the sole argument, in the following order:</p>

<ul>
<li>delivery.my.special.namespace</li>
<li>delivery.my.special</li>
<li>delivery.my</li>
<li>delivery</li>
</ul>

<h2 id="envelopes">Envelopes</h2>

<p>MMRP communicates by sending envelopes from node to node. An envelope is a type of object that is
instantiated by MMRP when it receives one, and you must instantiate yourself when you want to send
one. The public API for that is described below.</p>

<h3 id="envelope-api">Envelope API</h3>

<h4 id="construction">Construction</h4>

<p>You can get a hold of the Envelope class through MMRP, and instantiate it as follows.</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">Envelope</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">core</span><span class="p">.</span><span class="nx">msgServer</span><span class="p">.</span><span class="nx">mmrp</span><span class="p">.</span><span class="nx">Envelope</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s1">'something.i.made.up'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'hello'</span><span class="p">,</span> <span class="s1">'world'</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">route</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'someClusterId'</span><span class="p">,</span> <span class="s1">'someAddressOnThatCluster'</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">returnRoute</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'TRACK_ROUTE'</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">envelope</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Envelope</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">returnRoute</span><span class="p">,</span> <span class="nx">flags</span><span class="p">);</span>
</code></pre>
<h4 id="to-and-from-zeromq">To and from ZeroMQ</h4>

<p>To create an envelope from an array received through ZeroMQ, call:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">envelope</span> <span class="o">=</span> <span class="nx">Envelope</span><span class="p">.</span><span class="nx">fromArgs</span><span class="p">(</span><span class="nx">myArgs</span><span class="p">);</span>
</code></pre>
<p>To turn an envelope into an array that can be sent through ZeroMQ, call:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">envelope</span><span class="p">.</span><span class="nx">toArgs</span><span class="p">();</span>
</code></pre>
<h4 id="the-message">The message</h4>

<h5 id="envelope-setmessage-type-message">envelope.setMessage(type, message)</h5>

<p>Resets the envelope&rsquo;s type and message, where message is either a string, buffer or an array of
strings and buffers.</p>

<h5 id="envelope-addmessage-message">envelope.addMessage(message)</h5>

<p>Adds the message to the list of messages currently wrapped inside the envelope. The message must be
a buffer or a string.</p>

<h4 id="the-route">The route</h4>

<h5 id="envelope-setroute-route">envelope.setRoute(route)</h5>

<p>Resets the route of the envelope. The route must be an array, or a string (that becomes a 1-element
array) or falsy (to empty the route).</p>

<h5 id="envelope-consumeroute-identity">envelope.consumeRoute(identity)</h5>

<p>Removes the identity from the start of the route, if it&rsquo;s there. If no identity is given, the entire
route is emptied.</p>

<h5 id="envelope-routeremains">envelope.routeRemains()</h5>

<p>Returns true if there is a route left, false otherwise.</p>

<h5 id="envelope-getfinaldestination">envelope.getFinalDestination()</h5>

<p>Returns the final address in the route.</p>

<h4 id="the-return-route">The return route</h4>

<h5 id="envelope-setreturnroute-route">envelope.setReturnRoute(route)</h5>

<p>Like the <code class="prettyprint">setRoute(route)</code> function, and applying the same rules to its only argument, this sets
the return route of the message. In other words, if we want to send something back to the sender of
this envelope, we should use this returnRoute.</p>

<h5 id="envelope-injectsender-identity">envelope.injectSender(identity)</h5>

<p>Prepends an identity to the returnRoute.</p>

<h5 id="envelope-getinitialsource">envelope.getInitialSource()</h5>

<p>Returns the envelope&rsquo;s original sender identity.</p>

<h4 id="flags">Flags</h4>

<p>There is currently only 1 flag, namely &lsquo;TRACK_ROUTE&rsquo;. When this flag is active, the returnRoute must
be kept around in the envelope as it travels across the network.</p>

<h5 id="envelope-isflagged-flag">envelope.isFlagged(flag)</h5>

<p>Returns true if a flag is turned on for this envelope, false otherwise. The flag may be a string, or
its integer representation.</p>

<h5 id="envelope-getflags">envelope.getFlags()</h5>

<p>Returns an array with string representations of all flags that are turned on.</p>

<h5 id="envelope-setflag-flag">envelope.setFlag(flag)</h5>

<p>Turns a flag on.</p>

          <h1 id="message-stream">Message Stream</h1>

<h2 id="the-protocol">The protocol</h2>

<p>The serialization protocol used by the message stream is the same regardless of the transport type
used. Packages of messages are formatted in JSON as follows:</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"1"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">[</span><span class="s2">"some.event.name"</span><span class="p">],</span><span class="w">
    </span><span class="p">[</span><span class="s2">"another.event"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"some"</span><span class="p">:</span><span class="w"> </span><span class="s2">"data"</span><span class="w"> </span><span class="p">}]</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"2"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">[</span><span class="s2">"eventname"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"any"</span><span class="p">:</span><span class="w"> </span><span class="s2">"data"</span><span class="w"> </span><span class="p">}]</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>The key represents the message pack ID, which increments by 1 for each batch of messages emitted.
Messages must be processed in order of message pack ID and the array order in which they occur. The
content of the message is an array of 1 or 2 elements.</p>

<p>The first element is a string that represents the type of the message. This may be used as the event
name in a client-side event emitter. The optional second element is the real payload of the message.</p>

<p>Message types may be dot-separated. A client may choose to implement delivery of messages through
the emission of an event in chunks from most-relevant to least-relevant. For example, the message of
type <code class="prettyprint">shop.purchase</code> with data <code class="prettyprint">{ &quot;item&quot;: &quot;boots&quot; }</code> may be emitted twice:</p>

<ol>
<li><code class="prettyprint">shop.purchase</code> with data <code class="prettyprint">{ &quot;item&quot;: &quot;boots&quot; }</code></li>
<li><code class="prettyprint">shop</code> with data <code class="prettyprint">{ &quot;item&quot;: &quot;boots&quot; }</code></li>
</ol>

<p>Because networks (especially mobile) are not always reliable, MAGE will keep all messages on the
server until the client actively reports successful delivery. This is done per message pack ID.
Successful reception of these messages must be confirmed back to the server. Each transport
implements this mechanism in its own way.</p>

<h2 id="transport-types">Transport types</h2>

<h3 id="http-short-polling">HTTP short-polling</h3>

<p>With short-polling, the endpoint for message retrieval becomes:</p>
<pre class="highlight plaintext tab-plaintext"><code>GET http://domain/msgstream?sessionKey=abc&amp;transport=shortpolling&amp;confirmIds=1,2,3
</code></pre>
<p>Always be sure to pass the active session key for this user. Without it, no messages can be
delivered. If messages are available, they will be returned in the format described in
&ldquo;The protocol&rdquo;, with content-type <code class="prettyprint">application/json</code> and HTTP status code <code class="prettyprint">200</code>. If no messages are
available, HTTP status code <code class="prettyprint">204</code> will be returned without a response body.</p>

<p>Message pack IDs you want to confirm are to be sent back in the URL&rsquo;s query string named
<code class="prettyprint">confirmIds</code> and must be comma separated.</p>

<h3 id="http-long-polling">HTTP long-polling</h3>

<p>With long-polling, the endpoint for message retrieval becomes:</p>
<pre class="highlight plaintext tab-plaintext"><code>GET http://domain/msgstream?sessionKey=abc&amp;transport=longpolling&amp;confirmIds=1,2,3
</code></pre>
<p>Always be sure to pass the active session key for this user. Without it, no messages can be
delivered. If messages are available, they will be returned in the format described in
&ldquo;The protocol&rdquo;, with content-type <code class="prettyprint">application/json</code> and HTTP status code <code class="prettyprint">200</code>. This is no
different from short-polling. If there are no messages available however, the connection will hang
and wait for messages to arrive. The moment messages are ready for delivery, the HTTP request will
return with HTTP status code <code class="prettyprint">200</code> and content-type <code class="prettyprint">application/json</code>.</p>

<p>In order to reliably detect clients&rsquo; unavailability, the server will periodically close the
connection to the client. It is up to the client to detect this, and reconnect with the server to
make its presence known. The disconnect will happen with HTTP status code <code class="prettyprint">204</code> and does not carry a
response body.</p>

<p>Message pack IDs you want to confirm are to be sent back in the URL&rsquo;s query string named
<code class="prettyprint">confirmIds</code> and must be comma separated.</p>

<h3 id="websocket">WebSocket</h3>

<p>The WebSocket endpoint is:</p>
<pre class="highlight plaintext tab-plaintext"><code>ws://domain/msgstream?sessionKey=abc
</code></pre>
<p>Always be sure to pass the active session key for this user. Without it, no messages can be
delivered. If messages are available, they will be returned in the format described in
&ldquo;The protocol&rdquo;.</p>

<p>Message pack IDs you want to confirm are to be sent back in single strings that are simply all the
IDs comma separated. For example: <code class="prettyprint">1,2,3</code>.</p>

          <h1 id="command-center">Command Center</h1>

<p>The Command Center handles the exposure and processing of MAGE module user commands (ie: RPC).</p>

<p>MAGE currently only supports the MAGE user command custom protocol, through <a href="./httpBatchHandler.js">httpBatchHandler</a>
It uses the following endpoint: <code class="prettyprint">/&lt;appname&gt;/</code>.</p>

<h2 id="access-from-the-client">Access from the client</h2>

<p>MAGE automatically adds functions to your modules to have easy access to your user commands. If you have a <code class="prettyprint">gift</code> user
command in a <code class="prettyprint">gifting</code> module, you can use <code class="prettyprint">mage.gifting.gift()</code>.</p>

<p>If you want to use the command directly, you have to use the <code class="prettyprint">msgServer</code> module.</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">mage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mage'</span><span class="p">);</span>
<span class="nx">mage</span><span class="p">.</span><span class="nx">msgServer</span><span class="p">.</span><span class="nx">sendCommand</span><span class="p">(</span><span class="s1">'gifting.gift'</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</code></pre>
<h2 id="user-commands">User commands</h2>

<p>A complete example is available in the walkthrough: <a href="../../docs/walkthrough/Modules.md">Writing modules</a>.</p>

          <h1 id="configuration">Configuration</h1>

<p>Configuration is hierarchical, and based upon the <code class="prettyprint">NODE_ENV</code> environment variable. Configuration
can be found in a number of places, and may be either JSON or YAML. In <strong>ascending</strong> importance:</p>

<ol>
<li>Module <code class="prettyprint">config</code> files</li>
<li>Game <code class="prettyprint">default</code> file</li>
<li>Personal configuration file</li>
<li>Optional <code class="prettyprint">environment</code> file</li>
</ol>

<p>For example, if a field exists in the game default configuration, and also in a module default
configuration, then the game configuration wins.</p>

<h2 id="module-default-files">Module default files</h2>

<p>A typical module is a folder that may look like:</p>

<ul>
<li><code class="prettyprint">missions</code>

<ul>
<li><code class="prettyprint">usercommands/</code></li>
<li><code class="prettyprint">index.js</code></li>
<li><code class="prettyprint">client.js</code></li>
<li><code class="prettyprint">component.json</code></li>
<li><code class="prettyprint">config.yaml</code></li>
</ul></li>
</ul>

<p>When you tell Mage to use a module, it will automatically know that it should look for and load the
default configuration file. It may be a YAML or a JSON file. Your choice. If no file is found, then
Mage doesn&rsquo;t mind and assumes that no configuration was necessary. A <code class="prettyprint">config.yaml</code> file that
looks like:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">hello</span><span class="pi">:</span> <span class="s">world</span>
</code></pre>
<p>will be loaded into the Mage configuration object under <code class="prettyprint">module.missions</code>. The <code class="prettyprint">module</code> field is
fixed, and the <code class="prettyprint">missions</code> field is taken from the name of the module in the file system. The mage
configuration object will look like (considering only the added data):</p>
<pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"module"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"missions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"hello"</span><span class="p">:</span><span class="w"> </span><span class="s2">"world"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Remember, this is the lowest importance of configuration. You can choose to override it with the
game default configuration file, or a personal configuration file.</p>

<h2 id="game-default-file">Game default file</h2>

<p>The game default file should contain fields common to, or sensible as defaults in, all
environments. Remember, the production and personal configuration files override the content of
this file, so having things in here does not limit you. This file lives in the top level of your
game project, in the <code class="prettyprint">config/</code> folder.</p>

<h2 id="personal-configuration-file">Personal configuration file</h2>

<p>Finally, the environment variable <code class="prettyprint">NODE_ENV</code> is read to determine which file to use as a personal
configuration. These files live in the <code class="prettyprint">config/</code> directory along with the <code class="prettyprint">default</code> configuration
file. The value of <code class="prettyprint">NODE_ENV</code> should be equal to the name of the configuration file you want to
use, sans extension. i.e. If your <code class="prettyprint">NODE_ENV</code> resolves to <code class="prettyprint">me</code>, then the personal configuration file
to be used should be called <code class="prettyprint">me.json</code> or <code class="prettyprint">me.yaml</code> (don&rsquo;t have both in the directory, just don&rsquo;t).
Make sure you set this environment variable in your <code class="prettyprint">.bash_profile</code> or <code class="prettyprint">.profile</code> so you don&rsquo;t have
to keep typing it.</p>

<h2 id="environment-file">Environment file</h2>

<p>The environment file should be called <code class="prettyprint">environment.json</code> or <code class="prettyprint">environment.yaml</code> and allows the user
to define variables in the configuration that might be overridden by environment variables, it takes
the same format as the original configuration files but instead of a value the name of the environment
variable should be used.</p>

<p>For example if one wants <code class="prettyprint">database.mysql.url</code> to be overridden by an optional <code class="prettyprint">DB_URL</code> variable:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">database</span><span class="pi">:</span>
  <span class="na">mysql</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">DB_URL</span>
</code></pre>
<p>Environment variables also support casting to <code class="prettyprint">int</code>, <code class="prettyprint">float</code> or <code class="prettyprint">bool</code> by adding a colon and the
type right after it inside your <code class="prettyprint">environment</code> file:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">foo</span><span class="pi">:</span>
  <span class="na">variable_int</span><span class="pi">:</span> <span class="s">VAR_INT:int</span> <span class="c1"># will cast VAR_INT to int</span>
  <span class="na">variable_float</span><span class="pi">:</span> <span class="s">VAR_FLOAT:float</span>
<span class="na">bar</span><span class="pi">:</span>
  <span class="na">variable_bool</span><span class="pi">:</span> <span class="s">VAR_BOOL:bool</span>
</code></pre>
<h2 id="methods">Methods</h2>

<p>The methods of the configuration object should be avoided most of the time and are mainly for mage
internal use. However, there may be cases for which configuration is automatically generated etc.
, when these methods may be useful.</p>

<p><code class="prettyprint">mage.core.config</code> exposes the following methods:</p>

<ul>
<li><code class="prettyprint">get(path, [alt]);</code></li>
<li><code class="prettyprint">getSource(path)</code></li>
<li><code class="prettyprint">getMatryoshka()</code></li>
<li><code class="prettyprint">loadModuleConfig(moduleName, absolutePathToConfigFile);</code></li>
<li><code class="prettyprint">setDefaults(absolutePathToConfigFile);</code></li>
<li><code class="prettyprint">initialize(mageLogger)</code></li>
</ul>

<h3 id="get"><code class="prettyprint">get</code></h3>

<p>A safe getter function. The <code class="prettyprint">path</code> should be an array of keys of increasing depth, but can
optionally be a dot delimited string. The optional <code class="prettyprint">alt</code> parameter is a value to use if there is
no value found at this path. By default <code class="prettyprint">undefined</code> will be returned if the object does not have
this path. Unlike earlier versions of configuration, <code class="prettyprint">get</code> is necessary to extract configuration
data.</p>

<h3 id="getsource"><code class="prettyprint">getSource</code></h3>

<p>This uses a path array (or string) just like <code class="prettyprint">get</code>, but returns information about the source of the
configuration.</p>

<h3 id="getmatryoshka"><code class="prettyprint">getMatryoshka</code></h3>

<p>This returns a <em>copy</em> of the underlying data structure that contains your aggregated configuration.
This may be useful for tools or for debugging.</p>

<h3 id="loadmoduleconfig"><code class="prettyprint">loadModuleConfig</code></h3>

<p>This is used by Mage only. This function is used when Mage is setting up a module, and is
responsible for loading the default configuration file, if one exists. Just place a file called
<code class="prettyprint">config.&lt;json, yaml, js&gt;</code> and Mage will pick it up.</p>

<h3 id="setdefaults"><code class="prettyprint">setDefaults</code></h3>

<p>Merges an object into an existing configuration, without overriding existing content. This is
intended for Mage internal use and should not be used in games.</p>

<h3 id="initialize"><code class="prettyprint">initialize</code></h3>

<p>This is used by Mage to trigger a load of configuration files. It may only be called once.</p>

          <h1 id="logging">Logging</h1>

<h2 id="terminology">Terminology</h2>

<h3 id="channel">Channel</h3>

<p>Loggers have multiple channels (described at the bottom of this file) that define the verbosity or
severity of a log entry.</p>

<h3 id="message">Message</h3>

<p>The message is the primary line of information you are logging. In every case, whenever you pass a
message into a logger, you are encouraged to send multiple arguments and not do any serialization
(JSON or other) yourself. The reason for this is that some messages may be surpressed by the
configuration, based on verbosity, and needless serialization would needlessly hurt performance.</p>

<p>Loggers can serialize any data type, including Error instances (which will yield a stack trace).</p>

<h3 id="contexts">Contexts</h3>

<p>A logger can be given one or more contexts in order to make the source of a log-call a bit clearer.</p>

<h3 id="details">Details</h3>

<p>Additional details can be passed into a logger to clarify a situation with more human readable
output where needed. This is especially helpful when observing log output in a terminal.</p>

<h3 id="data">Data</h3>

<p>Loggers may be passed additional key/value data. This helps certain logging services (like Graylog2)
which allow users to query for data.</p>

<h2 id="api">API</h2>

<p>The <code class="prettyprint">logger</code> module is a logger instance that exposes multiple methods. Loggers expose several
methods.</p>

<h3 id="logger-context-context1-contextn">logger.context(context1, .., contextN)</h3>

<p>Returns a new logger object that has the given contexts on top of the ones that logger had. The
typical use case for this is that your module (eg: &lsquo;shop&rsquo;) has the following code at the top:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">context</span><span class="p">(</span><span class="s1">'shop'</span><span class="p">);</span>
<span class="c1">// all logging should now be done on logger</span>
</code></pre>
<h3 id="logger-channel-arg1-argn">logger.&lt;channel&gt;(arg1, .., argN)</h3>

<p>Each channel name is a method on a logger. This allows you to write:</p>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">emergency</span><span class="p">(</span><span class="s1">'Crucial file missing'</span><span class="p">);</span>
<span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warning</span><span class="p">(</span><span class="s1">'Stamina too low to quest:'</span><span class="p">,</span> <span class="nx">stamina</span><span class="p">,</span> <span class="s1">'quest:'</span><span class="p">,</span> <span class="nx">questId</span><span class="p">);</span>
<span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">verbose</span><span class="p">(</span><span class="s1">'Reading from file:'</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">);</span>
</code></pre>
<p>At the same time, the channel is not just a function, but an object that exposes a few more
methods. All those methods can be chained. Because you are no longer using the channel name as a
function, you have to call the <code class="prettyprint">log</code> method at the end of the chain to provide the log message (see
examples below).</p>

<h3 id="logger-channel-details-arg1-argn">logger.&lt;channel&gt;.details(arg1, .., argN)</h3>

<p>To provide additional human readable details. This function can be called multiple times to provide
multiple lines of information.</p>

<h3 id="logger-channel-context-context1-contextn">logger.&lt;channel&gt;.context(context1, .., contextN)</h3>

<p>This adds the contexts to this one log entry, on top of the ones that were already set before.</p>

<h3 id="logger-channel-data-key-value">logger.&lt;channel&gt;.data(key, value)</h3>

<p>Add a queryable key/value pair to the log entry.</p>

<h3 id="logger-channel-data-valuemap">logger.&lt;channel&gt;.data(valueMap)</h3>

<p>Add many key/value pairs to the queryable data of this log entry.</p>

<h3 id="logger-simulator-name">logger.simulator(name)</h3>

<p>This will return a shim for any of the supported 3rd party logger libraries. This can be useful when
interfacing with 3rd party modules that have a strong dependency on these loggers.</p>

<h2 id="examples">Examples</h2>

<h3 id="try-catch-block">try-catch block</h3>
<pre class="highlight javascript tab-javascript"><code><span class="k">try</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'You are too grey for me'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
<h3 id="passing-rich-data-that-certain-logging-services-may-be-able-to-query">Passing rich data that certain logging services may be able to query</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">({</span>
        <span class="na">playerId</span><span class="p">:</span> <span class="s1">'abc'</span><span class="p">,</span>
        <span class="na">questId</span><span class="p">:</span> <span class="nx">questId</span><span class="p">,</span>
        <span class="na">conditions</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">stamina</span><span class="p">:</span> <span class="nx">player</span><span class="p">.</span><span class="nx">stamina</span><span class="p">,</span>
            <span class="na">xp</span><span class="p">:</span> <span class="nx">player</span><span class="p">.</span><span class="nx">xp</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Trying to run quest'</span><span class="p">,</span> <span class="nx">questId</span><span class="p">);</span>
</code></pre>
<h3 id="passing-details">Passing details</h3>
<pre class="highlight javascript tab-javascript"><code><span class="nx">mage</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span>
  <span class="p">.</span><span class="nx">details</span><span class="p">(</span><span class="s1">'Used Facebook mobile login'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">details</span><span class="p">(</span><span class="s1">'URL'</span><span class="p">,</span> <span class="nx">facebookServiceUrl</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'User logged in'</span><span class="p">,</span> <span class="nx">actorId</span><span class="p">);</span>
</code></pre>
<h2 id="html5-client-api">HTML5 Client API</h2>

<p>If configured, the client module will also expose all the channels, so you can log just like you do
on the server. The API is however limited to logging a <code class="prettyprint">message</code>. At this time, contexts, details
and key/value data are not supported. Stack traces of Error objects are automatically logged in the
data part however. The client can log to console, but also to the server.</p>

<h2 id="built-in-logging-channels">Built-in Logging Channels</h2>

<p>The built-in channels are designed to be granular and meaningful; this should help production
operation by allowing you to throw alerts properly (only 3-4 emergencies or alerts a minute should
alert operation, but it might take 100&rsquo;s of user errors a minute to trigger the same alerting).</p>

<table><thead>
<tr>
<th>Channel</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>verbose</td>
<td>Low-level debug information (I/O details, etc). Reserved to MAGE internals.</td>
</tr>
<tr>
<td>debug</td>
<td>Game server debugging information.</td>
</tr>
<tr>
<td>info</td>
<td>User command request information</td>
</tr>
<tr>
<td>notice</td>
<td>Services state change notification (example: third-party services and databases)</td>
</tr>
<tr>
<td>warning</td>
<td>An unusual situation occured, which should required analysis.</td>
</tr>
<tr>
<td>error</td>
<td>A user request caused an error. The user should still be able to continue using the services.</td>
</tr>
<tr>
<td>critical</td>
<td>A user is now stuck in a broken state which the system cannot naturally repair.</td>
</tr>
<tr>
<td>alert</td>
<td>Internal service (datastore API calls failed, etc) or external service are failing.</td>
</tr>
<tr>
<td>emergency</td>
<td>The app cannot boot or stopped unexpectedly.</td>
</tr>
</tbody></table>

<h2 id="configuration">Configuration</h2>

<p>The logger allows for logging in different &ldquo;writers&rdquo;. At this time, the following are available on
the server:</p>

<ul>
<li>terminal: log to the console</li>
<li>file: write to log files on disk</li>
<li>syslog: write to syslog through UDP</li>
<li>graylog: www.graylog2.com</li>
<li>websocket: streams the log on a <a href="../savvy/Readme.md">Savvy</a> websocket</li>
</ul>

<p>And the following are available on the client:</p>

<ul>
<li>console: outputs to console.log/warn/error</li>
<li>server: send log entries to the server to be reported in server-side writers</li>
</ul>

<p>Configuration happens in your config file in:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">html5</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre>
<p>Any time you see a channel range configuration, it may be a string describing a range of channels,
or an array of multiple of these strings. A range may contain <code class="prettyprint">&gt;</code>, <code class="prettyprint">&gt;=</code>, <code class="prettyprint">&lt;</code> and <code class="prettyprint">&lt;=</code> comparison
operators. The special string <code class="prettyprint">all</code> represents all channels.</p>

<h3 id="server-terminal">Server: Terminal</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span>
        <span class="na">terminal</span><span class="pi">:</span>
            <span class="na">channels</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">&gt;=info"</span><span class="pi">]</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="na">jsonIndent</span><span class="pi">:</span> <span class="s">2</span>
                <span class="na">jsonOutput</span><span class="pi">:</span> <span class="s">false</span> <span class="c1"># defaults to false, useful when piping output to another app</span>
                <span class="na">theme</span><span class="pi">:</span> <span class="s">default</span>
</code></pre>
<p>Available themes: <code class="prettyprint">default</code>, <code class="prettyprint">dark</code>, <code class="prettyprint">light</code>.</p>

<h3 id="server-file">Server: File</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span>
        <span class="na">file</span><span class="pi">:</span>
            <span class="na">channels</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">&gt;=debug"</span><span class="pi">]</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./logs"</span>

                <span class="c1"># optional:</span>
                <span class="na">jsonIndent</span><span class="pi">:</span> <span class="s">2</span>
                <span class="na">mode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0600"</span>    <span class="c1"># make sure this is a string!</span>

                <span class="na">fileNames</span><span class="pi">:</span>
                    <span class="s2">"</span><span class="s">app.log"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">all"</span>    <span class="c1"># this is configured by default and you may override it</span>
                    <span class="s2">"</span><span class="s">access.log"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">info"</span>
                    <span class="s2">"</span><span class="s">error.log"</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&gt;=warning"</span>
</code></pre>
<h3 id="server-syslog">Server: Syslog</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span>
        <span class="na">syslog</span><span class="pi">:</span>
            <span class="na">channels</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">&gt;=debug"</span><span class="pi">]</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>          <span class="c1"># host to connect to (IP or hostname)</span>
                <span class="na">port</span><span class="pi">:</span> <span class="s">514</span>                <span class="c1"># UDP port to connect to</span>
                <span class="na">appName</span><span class="pi">:</span> <span class="s">myGame</span>
                <span class="na">facility</span><span class="pi">:</span> <span class="s">1</span>              <span class="c1"># see syslog documentation</span>
                <span class="na">format</span><span class="pi">:</span>
                    <span class="na">multiLine</span><span class="pi">:</span> <span class="s">true</span>      <span class="c1"># allow newline characters</span>
                    <span class="na">indent</span><span class="pi">:</span> <span class="s">2</span>            <span class="c1"># indentation when serializing data in multiLine mode</span>
</code></pre>
<h3 id="server-graylog">Server: Graylog</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span>
        <span class="na">graylog</span><span class="pi">:</span>
            <span class="na">channels</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">&gt;=info"</span><span class="pi">]</span>
            <span class="na">config</span><span class="pi">:</span>
                <span class="na">servers</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.100.85"</span><span class="pi">,</span> <span class="nv">port</span><span class="pi">:</span> <span class="nv">12201</span> <span class="pi">}</span>
                    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">host</span><span class="pi">:</span> <span class="s2">"</span><span class="s">192.168.100.86"</span><span class="pi">,</span> <span class="nv">port</span><span class="pi">:</span> <span class="nv">12201</span> <span class="pi">}</span>
                <span class="na">facility</span><span class="pi">:</span> <span class="s">Application identifier</span>
                <span class="na">format</span><span class="pi">:</span>
                    <span class="na">multiLine</span><span class="pi">:</span> <span class="s">true</span>      <span class="c1"># allow newline characters</span>
                    <span class="na">embedDetails</span><span class="pi">:</span> <span class="s">false</span>  <span class="c1"># embed log details into the message</span>
                    <span class="na">embedData</span><span class="pi">:</span> <span class="s">false</span>     <span class="c1"># embed data into the message</span>
</code></pre>
<h3 id="server-websocket">Server: WebSocket</h3>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span>
        <span class="na">websocket</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre>
<p>Please note that channels are not supported in the websocket configuration. The channel description
array is to be passed as JSON into the connection once it has been established.</p>

<h3 id="html5-all-writers">HTML5: All writers</h3>

<p>MAGE will override the client&rsquo;s console object with it&rsquo;s own version that supports logging to the
server and hiding output on the client. If you do not want this behavior you can set disableOverride
to true, but MAGE will no longer be able to collect logs from the client.</p>

<h3 id="html5-console">HTML5: Console</h3>

<p>Logs to the browser&rsquo;s console.</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">logging</span><span class="pi">:</span>
    <span class="na">html5</span><span class="pi">:</span>
        <span class="na">disableOverride</span><span class="pi">:</span> <span class="s">false</span>
        <span class="na">console</span><span class="pi">:</span>
            <span class="na">channels</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">&gt;=verbose"</span><span class="pi">]</span>
        <span class="na">server</span><span class="pi">:</span>
            <span class="na">channels</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">&gt;=error"</span><span class="pi">]</span>
</code></pre>
          <h1 id="sampler">Sampler</h1>

<p>The sampler library is an interface for <a href="https://www.npmjs.org/package/panopticon">Panopticon</a>. It
uses configuration to handle the setup of panoptica, and exposes the methods of these panoptica as a
group. Sampler handles the sending of data to all of the panoptica, so you only need to worry about
the API.</p>

<h2 id="api">API</h2>

<ul>
<li><code class="prettyprint">sampler.set(path, id, n)</code>, where <code class="prettyprint">n</code>, a finite number, may replace a previous <code class="prettyprint">n</code> for this <code class="prettyprint">id</code>.</li>
<li><code class="prettyprint">sampler.inc(path, id, n)</code>, where <code class="prettyprint">n</code> is added to the previous value if <code class="prettyprint">n</code> is a finite number.
If <code class="prettyprint">n</code> is not a finite number, then it defaults to <code class="prettyprint">1</code>.</li>
<li><code class="prettyprint">sampler.sample(path, id, n)</code>, which keeps track of the max, min, average and standard deviation
of <code class="prettyprint">n</code> over an interval.</li>
<li><code class="prettyprint">sampler.timedSample(path, id, dt)</code>, which is like sample, but takes the output of a high
resolution timer <code class="prettyprint">dt</code> (or rather the difference between two timers).</li>
</ul>

<p>These methods take the same arguments as a panopticon, so please see the Panopticon documentation
for more details.</p>

<h2 id="configuration">Configuration</h2>

<p>Sampler is configured by giving it one ore more (named) intervals. For each such interval, data
will be aggregated and served on the HTTP and WebSocket Savvy routes.</p>

<p>Other configuration that may optionally be supplied are:</p>

<p><strong>sampleMage (boolean)</strong>
Indicates whether MAGE itself should automatically collect its internal metrics. This provides
information on data store operations, user commands, and more.</p>

<p><strong>bufferLength (integer)</strong>
Indicates how many aggregated results should be kept around in memory. More data means that
services querying for it can look further back into the past.</p>

<p>Example:</p>
<pre class="highlight yaml tab-yaml"><code><span class="na">sampler</span><span class="pi">:</span>
    <span class="na">sampleMage</span><span class="pi">:</span> <span class="s">true</span>
    <span class="na">bufferLength</span><span class="pi">:</span> <span class="s">100</span>
    <span class="na">intervals</span><span class="pi">:</span>
        <span class="na">realtimeish</span><span class="pi">:</span> <span class="s">1000</span>
        <span class="na">bytheminute</span><span class="pi">:</span> <span class="s">60000</span>
</code></pre>
<h2 id="access">Access</h2>

<p>The data can be accessed through the Savvy route: <code class="prettyprint">/savvy/sampler</code>, for example by doing an
<code class="prettyprint">HTTP GET</code> request to <code class="prettyprint">http://localhost/savvy/sampler</code>. The same URL (with the <code class="prettyprint">ws:</code> protocol) can
be used to create a WebSocket data stream. The &ldquo;ws&rdquo; module comes with a connector utility, so this
should work from your project (please do mind the hostname and port):</p>
<pre class="highlight sh tab-shell"><code>./node_modules/mage/node_modules/.bin/wscat --connect <span class="s2">"ws://localhost/savvy/sampler/"</span>
</code></pre>
<p>You can dig into the dataset by augmenting the path you query. For example, if all you care about is
the PID of the master process, you may query <code class="prettyprint">http://localhost/savvy/sampler/realtimeish/data/pid/values/master/val</code>.</p>

<p>While connected through a WebSocket, you may retrieve the buffered samples by sending a message
containing the string <code class="prettyprint">sendBufferedData</code>. This will send all deliveries, filtered through the path
you have used in the URL while connecting.</p>

          <h1 id="savvy">Savvy</h1>

<h2 id="api">API</h2>

<p>Savvy provides an HTTP server for various management interfaces. When running your project without
a master node, it will use the normal MAGE HTTP server. If there is a master process, Savvy will sit
in this master process, catching all HTTP requests to <code class="prettyprint">/savvy/...</code>. This makes it ideal for serving
data that the master process may be aggregating from workers. Two examples of this are the logger,
and the sampler subsystems.</p>

<ul>
<li><code class="prettyprint">getBaseUrl()</code></li>
<li><code class="prettyprint">addRoute(pathMatch, handler, type)</code></li>
</ul>

<p>The base URL is configuration driven, and can be resolved with the <code class="prettyprint">getBaseUrl</code> function.</p>

<p><code class="prettyprint">addRoute</code> is identical to the <code class="prettyprint">addRoute</code> method of the MAGE HTTP server, except that it will make
sure you are not registering a route outside of the <code class="prettyprint">/savvy/</code> URL space. Also, when calling this on
a worker node, it will be a no-operation. Savvy only registers your routes on the master node.</p>

          <h1 id="process-manager">Process Manager</h1>

<p>A MAGE game is really a collection of processes; one master process which spawns workers which are
in turn responsible for executing game logic.</p>

          <h1 id="mage-cli-tab-completion">Mage CLI &amp; Tab Completion</h1>

<h2 id="cli">CLI</h2>

<p>This module uses <a href="https://github.com/visionmedia/commander.js">commander</a> to
manage the command-line interface of MAGE.</p>

<p>Those are the commands you can pass to Mage:</p>

<p>To run those, <code class="prettyprint">cd</code> to the root folder of your game,
and use <code class="prettyprint">node . [command]</code> where <code class="prettyprint">[command]</code> is one of the commands listed below.</p>

<ul>
<li><code class="prettyprint">show-config [options] [trail]</code> output the full configuration, or the sub-config at the given trail in JSON</li>
<li><code class="prettyprint">archivist-create [vaults]</code>     create database environments for all configured vaults</li>
<li><code class="prettyprint">archivist-drop [vaults]</code>       destroy database environments for all configured vaults (use with caution!)</li>
<li><code class="prettyprint">archivist-migrate [version]</code>   migrates all vaults to the current version, or to the version requested</li>
<li><code class="prettyprint">start</code>                         start the application daemonized</li>
<li><code class="prettyprint">stop</code>                          stop the daemonized application</li>
<li><code class="prettyprint">restart</code>                       restart the daemonized application</li>
<li><code class="prettyprint">reload</code>                        recycle all workers with zero-downtime (not to be used on version changes)</li>
<li><code class="prettyprint">status</code>                        output the status of the daemonized application</li>
</ul>

<h2 id="tab-completion">Tab Completion</h2>

<h3 id="how-to-install">How to install</h3>

<h4 id="recommended-way">Recommended way:</h4>

<p><code class="prettyprint">make dev</code></p>

<p>Which will setup the githooks and the tab completion.</p>

<h4 id="you-can-also">You can also:</h4>

<p><code class="prettyprint">make dev-autocomplete</code></p>

<p>Which will only setup the tab completion.</p>

<h3 id="implementation-details">Implementation Details</h3>

<p>The current implementation of tab completion uses <a href="https://www.npmjs.org/package/tabalot">Tabalot</a>.</p>

<p>Tabalot pretty much works this way:</p>

<ul>
<li><code class="prettyprint">node . completion -- word</code> Provides tabcompletion for any command starting with <code class="prettyprint">word</code></li>
</ul>

<p>Because of a few tweaks we made to simplify the installation process, you can use:</p>

<ul>
<li><code class="prettyprint">node . completion --filename test_file --bash_completion bash_completion_file --save</code> Which will:

<ul>
<li>read information from your package.json to get the necessary information to create a tab completion script</li>
<li>save this tab completion script in <code class="prettyprint">test_file</code></li>
<li>add a line to <code class="prettyprint">bash_completion_file</code> (usually <code class="prettyprint">~/.bash_completion</code>), sourcing <code class="prettyprint">test_file</code></li>
</ul></li>
</ul>

<p>Typing make dev-autocomplete at the root folder of your Mage project will basically do this for you.
You will then have to <code class="prettyprint">source</code> your <code class="prettyprint">bash_completion</code> (usually <code class="prettyprint">~/.bash_completion</code>) file
or restart your shell to benefit from the tab completion.</p>

<p>Every command added to the <em>program</em> object in <code class="prettyprint">lib/cli/index.js</code> will benefit from tab completion.</p>

<h2 id="api">API</h2>

<h3 id="cli-run">cli.run()</h3>

<p>Parse the process arguments obtained via <code class="prettyprint">process.argv</code>.</p>

<h3 id="cli-program">cli.program</h3>

<p>Commander object which allows you to extend the provided CLI.</p>

<p><em>Example</em>:</p>
<pre class="highlight javascript tab-javascript"><code><span class="kd">var</span> <span class="nx">cli</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mage'</span><span class="p">).</span><span class="nx">cli</span><span class="p">;</span>
<span class="nx">cli</span><span class="p">.</span><span class="nx">program</span><span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">'--clown'</span><span class="p">,</span> <span class="s1">'Enables clown mode'</span><span class="p">);</span>
<span class="nx">cli</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
</code></pre>
<p>With the previous code, you should obtain the following:
&ldquo;`
$ ./game &ndash;verbose &ndash;help</p>

<p>Usage: game [options] [command]
&hellip;
  Options:
&hellip;
    &ndash;clown                Enables clown mode
&rdquo;`</p>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
